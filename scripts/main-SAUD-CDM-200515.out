
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # main.R
> # R to analyze spec/custom choice
> # Tom Davidoff
> 
> library(data.table)
> library(readstata13)
> library(fixest)
> library(ggplot2)
> 
> do16 <- 0
> if (do16==1)  {
+     (source("scripts/get16.R"))
+ }
> d16 <- fread("data/derived/baseline16.csv")
> print(summary(d16))
   folioID           roll_number             MB_year_built  MB_effective_year
 Length:25640       Min.   : 1023636540000   Min.   :1900   Min.   :1909     
 Class :character   1st Qu.: 5731056220000   1st Qu.:1942   1st Qu.:1970     
 Mode  :character   Median :16741216240000   Median :1978   Median :1986     
                    Mean   :14145787111320   Mean   :1971   Mean   :1985     
                    3rd Qu.:20586300230000   3rd Qu.:1997   3rd Qu.:2000     
                    Max.   :25830270550000   Max.   :2020   Max.   :2020     
                                             NA's   :24     NA's   :24       
   landValue       improvementValue   streetNumber  streetDirectionPrefix
 Min.   : 199000   Min.   :      0   Min.   :   3   Mode:logical         
 1st Qu.:1020000   1st Qu.:  53500   1st Qu.:1742   NA's:25640           
 Median :1213000   Median : 155000   Median :2879                        
 Mean   :1470442   Mean   : 238800   Mean   :3046                        
 3rd Qu.:1870000   3rd Qu.: 293000   3rd Qu.:4032                        
 Max.   :8880000   Max.   :3801000   Max.   :8571                        
                                     NA's   :2                           
  streetName         streetType        streetDirectionSuffix  postalCode       
 Length:25640       Length:25640       Length:25640          Length:25640      
 Class :character   Class :character   Class :character      Class :character  
 Mode  :character   Mode  :character   Mode  :character      Mode  :character  
                                                                               
                                                                               
                                                                               
                                                                               
     city             thirty          fifty           laneok       
 Length:25640       Mode :logical   Mode :logical   Mode :logical  
 Class :character   FALSE:4991      FALSE:20649     FALSE:503      
 Mode  :character   TRUE :20649     TRUE :4991      TRUE :23474    
                                                    NA's :1663     
                                                                   
                                                                   
                                                                   
> 
> do24 <- 0
> if (do24==1)  {
+     (source("scripts/get24.R"))
+ }
> d24 <- fread("data/derived/use24.csv")
> print(summary(d24))
   FOLIO_ID         ACTUAL_USE_DESCRIPTION JURISDICTION_CODE NEIGHBOURHOOD     
 Length:77530       Length:77530           Min.   :200       Length:77530      
 Class :character   Class :character       1st Qu.:200       Class :character  
 Mode  :character   Mode  :character       Median :200       Mode  :character  
                                           Mean   :200                         
                                           3rd Qu.:200                         
                                           Max.   :200                         
                                                                               
     nchar      splitspot    rollStart            rollEnd24       
 Min.   :15   Min.   :11   Min.   : 101963206   Min.   :   0.000  
 1st Qu.:15   1st Qu.:11   1st Qu.: 813073905   1st Qu.:   0.000  
 Median :15   Median :11   Median :1721681936   Median :   0.000  
 Mean   :15   Mean   :11   Mean   :1507320016   Mean   :   0.694  
 3rd Qu.:15   3rd Qu.:11   3rd Qu.:2163827160   3rd Qu.:   0.000  
 Max.   :15   Max.   :11   Max.   :2583027085   Max.   :4001.000  
                                                                  
  Jurisdiction MB_Year_Built     Zoning          ROLL_NUMBER24           
 Min.   :200   Min.   :1900   Length:77530       Min.   : 1019632060000  
 1st Qu.:200   1st Qu.:1950   Class :character   1st Qu.: 8130739050000  
 Median :200   Median :1986   Mode  :character   Median :17216819360000  
 Mean   :200   Mean   :1977                      Mean   :15073200163654  
 3rd Qu.:200   3rd Qu.:2008                      3rd Qu.:21638271600000  
 Max.   :200   Max.   :2023                      Max.   :25830270850000  
               NA's   :523                                               
 UNIT_NUMBER        STREET_NUMBER   STREET_DIRECTION_PREFIX STREET_NAME       
 Length:77530       Min.   :    1   Length:77530            Length:77530      
 Class :character   1st Qu.: 1753   Class :character        Class :character  
 Mode  :character   Median : 3074   Mode  :character        Mode  :character  
                    Mean   : 3229                                             
                    3rd Qu.: 4465                                             
                    Max.   :74088                                             
                    NA's   :21                                                
 STREET_TYPE        STREET_DIRECTION_SUFFIX POSTAL_CODE       
 Length:77530       Length:77530            Length:77530      
 Class :character   Class :character        Class :character  
 Mode  :character   Mode  :character        Mode  :character  
                                                              
                                                              
                                                              
                                                              
 fullStreet24       streetNoNumber24   streetNumber24 
 Length:77530       Length:77530       Min.   :    1  
 Class :character   Class :character   1st Qu.: 1753  
 Mode  :character   Mode  :character   Median : 3074  
                                       Mean   : 3229  
                                       3rd Qu.: 4465  
                                       Max.   :74088  
                                       NA's   :21     
> 
> 
> # merge on roll number fragment
> 
> d24[,rollStart:=as.numeric(rollStart)]
> d24[,rollEnd24:=as.numeric(rollEnd24)]
> 
> d16[,rollStart:=floor(roll_number/10000)]
> d16[,rollEnd16:=roll_number %% 10000]
> 
> d24 <- merge(d24,d16,by.x=c("rollStart"),by.y=c("rollStart")) 
> print(summary(d24))
   rollStart           FOLIO_ID         ACTUAL_USE_DESCRIPTION
 Min.   :1.024e+08   Length:31936       Length:31936          
 1st Qu.:5.737e+08   Class :character   Class :character      
 Median :1.676e+09   Mode  :character   Mode  :character      
 Mean   :1.436e+09                                            
 3rd Qu.:2.059e+09                                            
 Max.   :2.583e+09                                            
                                                              
 JURISDICTION_CODE NEIGHBOURHOOD          nchar      splitspot 
 Min.   :200       Length:31936       Min.   :15   Min.   :11  
 1st Qu.:200       Class :character   1st Qu.:15   1st Qu.:11  
 Median :200       Mode  :character   Median :15   Median :11  
 Mean   :200                          Mean   :15   Mean   :11  
 3rd Qu.:200                          3rd Qu.:15   3rd Qu.:11  
 Max.   :200                          Max.   :15   Max.   :11  
                                                               
   rollEnd24        Jurisdiction MB_Year_Built     Zoning         
 Min.   :0.00000   Min.   :200   Min.   :1900   Length:31936      
 1st Qu.:0.00000   1st Qu.:200   1st Qu.:1949   Class :character  
 Median :0.00000   Median :200   Median :1989   Mode  :character  
 Mean   :0.01976   Mean   :200   Mean   :1979                     
 3rd Qu.:0.00000   3rd Qu.:200   3rd Qu.:2011                     
 Max.   :3.00000   Max.   :200   Max.   :2023                     
                                 NA's   :137                      
 ROLL_NUMBER24            UNIT_NUMBER        STREET_NUMBER  
 Min.   : 1023636540000   Length:31936       Min.   :    2  
 1st Qu.: 5737097260000   Class :character   1st Qu.: 1551  
 Median :16758201410000   Mode  :character   Median : 2887  
 Mean   :14362021408364                      Mean   : 3041  
 3rd Qu.:20587300480001                      3rd Qu.: 4048  
 Max.   :25830270550000                      Max.   :74088  
                                             NA's   :4      
 STREET_DIRECTION_PREFIX STREET_NAME        STREET_TYPE       
 Length:31936            Length:31936       Length:31936      
 Class :character        Class :character   Class :character  
 Mode  :character        Mode  :character   Mode  :character  
                                                              
                                                              
                                                              
                                                              
 STREET_DIRECTION_SUFFIX POSTAL_CODE        fullStreet24      
 Length:31936            Length:31936       Length:31936      
 Class :character        Class :character   Class :character  
 Mode  :character        Mode  :character   Mode  :character  
                                                              
                                                              
                                                              
                                                              
 streetNoNumber24   streetNumber24    folioID           roll_number            
 Length:31936       Min.   :    2   Length:31936       Min.   : 1023636540000  
 Class :character   1st Qu.: 1551   Class :character   1st Qu.: 5737097260000  
 Mode  :character   Median : 2887   Mode  :character   Median :16758201410000  
                    Mean   : 3041                      Mean   :14362021408364  
                    3rd Qu.: 4048                      3rd Qu.:20587300480000  
                    Max.   :74088                      Max.   :25830270550000  
                    NA's   :4                                                  
 MB_year_built  MB_effective_year   landValue       improvementValue 
 Min.   :1900   Min.   :1909      Min.   : 199000   Min.   :      0  
 1st Qu.:1946   1st Qu.:1970      1st Qu.:1020000   1st Qu.:  52900  
 Median :1984   Median :1990      Median :1219000   Median : 169000  
 Mean   :1975   Mean   :1988      Mean   :1458804   Mean   : 265909  
 3rd Qu.:2009   3rd Qu.:2010      3rd Qu.:1840000   3rd Qu.: 348000  
 Max.   :2020   Max.   :2020      Max.   :8880000   Max.   :3801000  
 NA's   :50     NA's   :50                                           
  streetNumber  streetDirectionPrefix  streetName         streetType       
 Min.   :   3   Mode:logical          Length:31936       Length:31936      
 1st Qu.:1542   NA's:31936            Class :character   Class :character  
 Median :2886                         Mode  :character   Mode  :character  
 Mean   :3035                                                              
 3rd Qu.:4043                                                              
 Max.   :8571                                                              
 NA's   :4                                                                 
 streetDirectionSuffix  postalCode            city             thirty       
 Length:31936          Length:31936       Length:31936       Mode :logical  
 Class :character      Class :character   Class :character   FALSE:6223     
 Mode  :character      Mode  :character   Mode  :character   TRUE :25713    
                                                                            
                                                                            
                                                                            
                                                                            
   fifty           laneok          rollEnd16
 Mode :logical   Mode :logical   Min.   :0  
 FALSE:25713     FALSE:567       1st Qu.:0  
 TRUE :6223      TRUE :27733     Median :0  
                 NA's :3636      Mean   :0  
                                 3rd Qu.:0  
                                 Max.   :0  
                                            
> 
> dLaneway <- openxlsx::read.xlsx("data/raw/20250401_UBC_CustomLanewayReport.xlsx")
> #dLaneway <- read.dta13("data/raw/Laneway list 2015-23.dta")
> print(names(dLaneway))
[1] "Area"      "Jur"       "Roll"      "PID"       "PrimAUC"   "MCC"      
[7] "YearBuilt"
> dLaneway <- data.table(dLaneway)[,.(Roll,Jur,YearBuilt)]
> print(table(dLaneway[,Jur]))

 200 
5918 
> dLaneway[,Jur==NULL]
logical(0)
> dLaneway[,Roll:=as.character(as.numeric(Roll))]
> dLaneway[,hasLaneway:=1]
> d24[,Roll:=as.character(roll_number)]
> 
> d24 <- merge(d24,dLaneway,by="Roll",all.x=TRUE,all.y=TRUE)
> print(table(d24[,.(is.na(hasLaneway),is.na(rollEnd24))])) # about 50% of laneways -- not bad as all 30 50
       V2
V1      FALSE  TRUE
  FALSE  7441  3957
  TRUE  24495     0
> print(summary(d24[hasLaneway==1]))
     Roll             rollStart           FOLIO_ID        
 Length:11398       Min.   :1.634e+08   Length:11398      
 Class :character   1st Qu.:9.714e+08   Class :character  
 Mode  :character   Median :1.780e+09   Mode  :character  
                    Mean   :1.561e+09                     
                    3rd Qu.:2.161e+09                     
                    Max.   :2.583e+09                     
                    NA's   :3957                          
 ACTUAL_USE_DESCRIPTION JURISDICTION_CODE NEIGHBOURHOOD          nchar     
 Length:11398           Min.   :200       Length:11398       Min.   :15    
 Class :character       1st Qu.:200       Class :character   1st Qu.:15    
 Mode  :character       Median :200       Mode  :character   Median :15    
                        Mean   :200                          Mean   :15    
                        3rd Qu.:200                          3rd Qu.:15    
                        Max.   :200                          Max.   :15    
                        NA's   :3957                         NA's   :3957  
   splitspot      rollEnd24     Jurisdiction  MB_Year_Built     Zoning         
 Min.   :11     Min.   :0      Min.   :200    Min.   :1905   Length:11398      
 1st Qu.:11     1st Qu.:0      1st Qu.:200    1st Qu.:2007   Class :character  
 Median :11     Median :0      Median :200    Median :2013   Mode  :character  
 Mean   :11     Mean   :0      Mean   :200    Mean   :2002                     
 3rd Qu.:11     3rd Qu.:0      3rd Qu.:200    3rd Qu.:2017                     
 Max.   :11     Max.   :0      Max.   :200    Max.   :2023                     
 NA's   :3957   NA's   :3957   NA's   :3957   NA's   :3997                     
 ROLL_NUMBER24            UNIT_NUMBER        STREET_NUMBER  
 Min.   : 1634037190000   Length:11398       Min.   :    2  
 1st Qu.: 9714153140000   Class :character   1st Qu.: 1079  
 Median :17803197640000   Mode  :character   Median : 2807  
 Mean   :15611953793535                      Mean   : 2979  
 3rd Qu.:21607280300000                      3rd Qu.: 4043  
 Max.   :25828251390000                      Max.   :74088  
 NA's   :          3957                      NA's   :3957   
 STREET_DIRECTION_PREFIX STREET_NAME        STREET_TYPE       
 Length:11398            Length:11398       Length:11398      
 Class :character        Class :character   Class :character  
 Mode  :character        Mode  :character   Mode  :character  
                                                              
                                                              
                                                              
                                                              
 STREET_DIRECTION_SUFFIX POSTAL_CODE        fullStreet24      
 Length:11398            Length:11398       Length:11398      
 Class :character        Class :character   Class :character  
 Mode  :character        Mode  :character   Mode  :character  
                                                              
                                                              
                                                              
                                                              
 streetNoNumber24   streetNumber24    folioID           roll_number            
 Length:11398       Min.   :    2   Length:11398       Min.   : 1634037190000  
 Class :character   1st Qu.: 1079   Class :character   1st Qu.: 9714153140000  
 Mode  :character   Median : 2807   Mode  :character   Median :17803197640000  
                    Mean   : 2979                      Mean   :15611953793535  
                    3rd Qu.: 4043                      3rd Qu.:21607280300000  
                    Max.   :74088                      Max.   :25828251390000  
                    NA's   :3957                       NA's   :          3957  
 MB_year_built  MB_effective_year   landValue       improvementValue 
 Min.   :1905   Min.   :1928      Min.   : 684000   Min.   :      0  
 1st Qu.:1989   1st Qu.:1996      1st Qu.:1020000   1st Qu.:  48500  
 Median :2012   Median :2012      Median :1125000   Median : 286000  
 Mean   :1995   Mean   :2003      Mean   :1367980   Mean   : 379251  
 3rd Qu.:2015   3rd Qu.:2015      3rd Qu.:1650000   3rd Qu.: 581000  
 Max.   :2020   Max.   :2020      Max.   :3574000   Max.   :1836000  
 NA's   :3986   NA's   :3986      NA's   :3957      NA's   :3957     
  streetNumber  streetDirectionPrefix  streetName         streetType       
 Min.   :   8   Mode:logical          Length:11398       Length:11398      
 1st Qu.:1060   NA's:11398            Class :character   Class :character  
 Median :2805                         Mode  :character   Mode  :character  
 Mean   :2956                                                              
 3rd Qu.:4039                                                              
 Max.   :8273                                                              
 NA's   :3957                                                              
 streetDirectionSuffix  postalCode            city             thirty       
 Length:11398          Length:11398       Length:11398       Mode :logical  
 Class :character      Class :character   Class :character   FALSE:1471     
 Mode  :character      Mode  :character   Mode  :character   TRUE :5970     
                                                             NA's :3957     
                                                                            
                                                                            
                                                                            
   fifty           laneok          rollEnd16        Jur           
 Mode :logical   Mode :logical   Min.   :   0   Length:11398      
 FALSE:5970      FALSE:32        1st Qu.:   0   Class :character  
 TRUE :1471      TRUE :5110      Median :   0   Mode  :character  
 NA's :3957      NA's :6256      Mean   :   0                     
                                 3rd Qu.:   0                     
                                 Max.   :   0                     
                                 NA's   :3957                     
  YearBuilt           hasLaneway
 Length:11398       Min.   :1   
 Class :character   1st Qu.:1   
 Mode  :character   Median :1   
                    Mean   :1   
                    3rd Qu.:1   
                    Max.   :1   
                                
> print(summary(d24[,YearBuilt==MB_Year_Built]))
   Mode   FALSE    TRUE    NA's 
logical    3058    4343   28492 
> print(d24[hasLaneway==1 & YearBuilt!=MB_Year_Built])
Key: <Roll>
                Roll  rollStart   FOLIO_ID          ACTUAL_USE_DESCRIPTION
              <char>      <num>     <char>                          <char>
   1: 10813124770000 1081312477 A000001CV1 Residential Dwelling with Suite
   2: 10813124770000 1081312477 A000001CV1 Residential Dwelling with Suite
   3: 10813124770000 1081312477 A000001CV1 Residential Dwelling with Suite
   4: 10813124770000 1081312477 A000001CV1 Residential Dwelling with Suite
   5: 10813124770000 1081312477 A000001CV1 Residential Dwelling with Suite
  ---                                                                     
3054:  9747179640000  974717964 A000001ALB Residential Dwelling with Suite
3055:  9747179640000  974717964 A000001ALB Residential Dwelling with Suite
3056:  9747179640000  974717964 A000001ALB Residential Dwelling with Suite
3057:  9747179640000  974717964 A000001ALB Residential Dwelling with Suite
3058:  9747179640000  974717964 A000001ALB Residential Dwelling with Suite
      JURISDICTION_CODE   NEIGHBOURHOOD nchar splitspot rollEnd24 Jurisdiction
                  <int>          <char> <int>     <int>     <num>        <int>
   1:               200 South Granville    15        11         0          200
   2:               200 South Granville    15        11         0          200
   3:               200 South Granville    15        11         0          200
   4:               200 South Granville    15        11         0          200
   5:               200 South Granville    15        11         0          200
  ---                                                                         
3054:               200          Cambie    15        11         0          200
3055:               200          Cambie    15        11         0          200
3056:               200          Cambie    15        11         0          200
3057:               200          Cambie    15        11         0          200
3058:               200          Cambie    15        11         0          200
      MB_Year_Built Zoning  ROLL_NUMBER24 UNIT_NUMBER STREET_NUMBER
              <int> <char>          <i64>      <char>         <int>
   1:          1988    RS1 10813124770000                      1523
   2:          1988    RS1 10813124770000                      1523
   3:          1988    RS1 10813124770000                      1523
   4:          1988    RS1 10813124770000                      1525
   5:          1988    RS1 10813124770000                      1525
  ---                                                              
3054:          1940    RS1  9747179640000                       136
3055:          1940    RS1  9747179640000                       136
3056:          1940    RS1  9747179640000                       138
3057:          1940    RS1  9747179640000                       138
3058:          1940    RS1  9747179640000                       138
      STREET_DIRECTION_PREFIX STREET_NAME STREET_TYPE STREET_DIRECTION_SUFFIX
                       <char>      <char>      <char>                  <char>
   1:                                59TH         AVE                       W
   2:                                59TH         AVE                       W
   3:                                59TH         AVE                       W
   4:                                59TH         AVE                       W
   5:                                59TH         AVE                       W
  ---                                                                        
3054:                                40TH         AVE                       W
3055:                                40TH         AVE                       W
3056:                                40TH         AVE                       W
3057:                                40TH         AVE                       W
3058:                                40TH         AVE                       W
      POSTAL_CODE     fullStreet24 streetNoNumber24 streetNumber24    folioID
           <char>           <char>           <char>          <int>     <char>
   1:     V6P 1Z1 1523  59TH AVE W       59TH AVE W           1523 A000001CV1
   2:     V6P 1Z1 1523  59TH AVE W       59TH AVE W           1523 A000001CV1
   3:     V6P 1Z1 1523  59TH AVE W       59TH AVE W           1523 A000001CV1
   4:     V6P 1Z1 1525  59TH AVE W       59TH AVE W           1525 A000001CV1
   5:     V6P 1Z1 1525  59TH AVE W       59TH AVE W           1525 A000001CV1
  ---                                                                        
3054:     V5Y 2R2  136  40TH AVE W       40TH AVE W            136 A000001ALB
3055:     V5Y 2R2  136  40TH AVE W       40TH AVE W            136 A000001ALB
3056:     V5Y 2R2  138  40TH AVE W       40TH AVE W            138 A000001ALB
3057:     V5Y 2R2  138  40TH AVE W       40TH AVE W            138 A000001ALB
3058:     V5Y 2R2  138  40TH AVE W       40TH AVE W            138 A000001ALB
         roll_number MB_year_built MB_effective_year landValue improvementValue
               <i64>         <int>             <int>     <int>            <int>
   1: 10813124770000          1988              1991   2143000           380000
   2: 10813124770000          1988              1991   2143000           380000
   3: 10813124770000          1988              1991   2143000           380000
   4: 10813124770000          1988              1991   2143000           380000
   5: 10813124770000          1988              1991   2143000           380000
  ---                                                                          
3054:  9747179640000          1940              1995   2082000           753000
3055:  9747179640000          1940              1995   2082000           753000
3056:  9747179640000          1940              1995   2082000           753000
3057:  9747179640000          1940              1995   2082000           753000
3058:  9747179640000          1940              1995   2082000           753000
      streetNumber streetDirectionPrefix streetName streetType
             <int>                <lgcl>     <char>     <char>
   1:         1523                    NA       59TH        AVE
   2:         1525                    NA       59TH        AVE
   3:         1527                    NA       59TH        AVE
   4:         1523                    NA       59TH        AVE
   5:         1525                    NA       59TH        AVE
  ---                                                         
3054:          138                    NA       40TH        AVE
3055:          140                    NA       40TH        AVE
3056:          136                    NA       40TH        AVE
3057:          138                    NA       40TH        AVE
3058:          140                    NA       40TH        AVE
      streetDirectionSuffix postalCode      city thirty  fifty laneok rollEnd16
                     <char>     <char>    <char> <lgcl> <lgcl> <lgcl>     <i64>
   1:                     W    V6P 1Z1 VANCOUVER  FALSE   TRUE   TRUE         0
   2:                     W    V6P 1Z1 VANCOUVER  FALSE   TRUE   TRUE         0
   3:                     W    V6P 1Z1 VANCOUVER  FALSE   TRUE   TRUE         0
   4:                     W    V6P 1Z1 VANCOUVER  FALSE   TRUE   TRUE         0
   5:                     W    V6P 1Z1 VANCOUVER  FALSE   TRUE   TRUE         0
  ---                                                                          
3054:                     W            VANCOUVER  FALSE   TRUE     NA         0
3055:                     W    V5Y 2R2 VANCOUVER  FALSE   TRUE   TRUE         0
3056:                     W    V5Y 2R2 VANCOUVER  FALSE   TRUE     NA         0
3057:                     W            VANCOUVER  FALSE   TRUE     NA         0
3058:                     W    V5Y 2R2 VANCOUVER  FALSE   TRUE   TRUE         0
         Jur YearBuilt hasLaneway
      <char>    <char>      <num>
   1:    200      2016          1
   2:    200      2016          1
   3:    200      2016          1
   4:    200      2016          1
   5:    200      2016          1
  ---                            
3054:    200      2011          1
3055:    200      2011          1
3056:    200      2011          1
3057:    200      2011          1
3058:    200      2011          1
> d24[,hasLaneway:=ifelse(is.na(hasLaneway),0,hasLaneway)]
> 
> # get max transaction date by roll rumber
> dMaxSale <- fread("data/derived/maxSale.csv")
> d24 <- merge(d24,dMaxSale,by.x="ROLL_NUMBER24",by.y="ROLL_NUMBER",all.x=TRUE)
> d24[,duplex:=grepl("Duplex,",ACTUAL_USE_DESCRIPTION)]
> d24[,basement:=grepl("Residential Dwelling with Suite",ACTUAL_USE_DESCRIPTION)]
> d24[,single:=grepl("Single Family Dwelling",ACTUAL_USE_DESCRIPTION)]
> d24[,type:=ifelse(duplex==1,"duplex",ifelse(hasLaneway==1,"laneway",ifelse(basement==1,"basement",ifelse(single==1,"single","other"))))]
> print(table(d24[,type]))

basement   duplex  laneway    other   single 
   12763      740    11386      143    10861 
> print(summary(d24[,MB_Year_Built]))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   1900    1949    1989    1979    2011    2023    4094 
> d24[,spec:=0]
> d24[,sale2024:=0]
> FIRST_BUILT <- 2010 # Note can do early for the non-duplex stuff, and no duplex really pre-18
> LAST_BUILT <- 2023 # pre-duplex era?
> for (y in seq(FIRST_BUILT,LAST_BUILT)) {
+     #d24[MB_Year_Built==y & (get(paste0("sale",y))==1 | get(paste0("sale",y+1))==1 | get(paste0("sale",y+2))==1  ),spec:=1]
+     d24[MB_Year_Built==y & (get(paste0("sale",y))==1 | get(paste0("sale",y+1))==1  ),spec:=1]
+     #d24[MB_Year_Built==y & ( get(paste0("sale",y+1))==1  ),spec:=1]
+ }
> for (y in seq(FIRST_BUILT,LAST_BUILT)) {
+     print(y)
+     print(table(d24[MB_Year_Built==y,.(type,spec)]))
+ }
[1] 2010
          spec
type         0   1
  basement 158 124
  laneway  150  54
  other      4   0
  single    25  24
[1] 2011
          spec
type         0   1
  basement 230 198
  laneway  306 206
  other      4   0
  single    48  42
[1] 2012
          spec
type         0   1
  basement 216 207
  laneway  320 213
  other      0   1
  single    49  50
[1] 2013
          spec
type         0   1
  basement 158 150
  laneway  350 188
  single    44  30
[1] 2014
          spec
type         0   1
  basement 124 126
  laneway  396 202
  single    35  30
[1] 2015
          spec
type         0   1
  basement 140  62
  duplex     9   0
  laneway  539 267
  single    48  17
[1] 2016
          spec
type         0   1
  basement  58  20
  laneway  302 100
  single    24  10
[1] 2017
          spec
type         0   1
  basement  51  12
  duplex     1   0
  laneway  295  52
  single    45   6
[1] 2018
          spec
type         0   1
  basement  88   8
  laneway  339  78
  single    49   3
[1] 2019
          spec
type         0   1
  basement  47   8
  duplex    19   1
  laneway  265  54
  single    32   1
[1] 2020
          spec
type         0   1
  basement  39   8
  duplex    38  79
  laneway  189  25
  single    14   1
[1] 2021
          spec
type         0   1
  basement  30  10
  duplex    79 101
  laneway  123  40
  single    18   5
[1] 2022
          spec
type         0   1
  basement  34  10
  duplex   138 107
  laneway  242  29
  single    31   7
[1] 2023
          spec
type         0   1
  basement  31   0
  duplex    87  11
  laneway  119   4
  other      4   0
  single    26   0
> 
> print(table(d24[MB_Year_Built>2016 & MB_Year_Built<2023,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement  67   9
  duplex   139 131
  laneway  505 119
  single    35   2

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement  70  14
  duplex    85 133
  laneway  544 120
  single    23   3

, , STREET_DIRECTION_SUFFIX = N

          spec
type         0   1
  basement   0   0
  duplex     0   1
  laneway    4   2
  single     0   0

, , STREET_DIRECTION_SUFFIX = SE

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement 152  33
  duplex    51  23
  laneway  397  37
  single   131  18

> print(table(d24[thirty==1 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement  49   9
  duplex    45  57
  laneway  350 101
  single    22   1

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement  63   9
  duplex    33  76
  laneway  400  93
  single    12   0

, , STREET_DIRECTION_SUFFIX = N

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    4   2
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement  91  25
  duplex    15   8
  laneway  197  28
  single    67  11

> print(table(d24[thirty==0 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement   5   0
  duplex    22  16
  laneway   76   7
  single     9   1

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement   2   2
  duplex    15  20
  laneway   55  16
  single     1   0

, , STREET_DIRECTION_SUFFIX = SE

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement  45   1
  duplex     7   4
  laneway  126   2
  single    47   3

> print(table(d24[thirty==1 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,NEIGHBOURHOOD)]))
, , NEIGHBOURHOOD = Arbutus Ridge - Mackenzie Heights

          spec
type         0   1
  basement   2   3
  duplex     0   0
  laneway   22   0
  single     4   0

, , NEIGHBOURHOOD = Cambie

          spec
type         0   1
  basement  20   5
  duplex     5   0
  laneway   42   4
  single     6   1

, , NEIGHBOURHOOD = Cedar Cottage

          spec
type         0   1
  basement   6   7
  duplex     0   4
  laneway   15   6
  single     4   0

, , NEIGHBOURHOOD = Collingwood

          spec
type         0   1
  basement   4   0
  duplex     4  12
  laneway   26   3
  single     0   0

, , NEIGHBOURHOOD = Dunbar

          spec
type         0   1
  basement  22   5
  duplex     0   0
  laneway   31   3
  single    24   5

, , NEIGHBOURHOOD = Fraserview

          spec
type         0   1
  basement   1   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , NEIGHBOURHOOD = Grandview

          spec
type         0   1
  basement   0   0
  duplex     2  10
  laneway    5   0
  single     0   0

, , NEIGHBOURHOOD = Hastings East

          spec
type         0   1
  basement  16   0
  duplex    17  12
  laneway   87  30
  single     8   1

, , NEIGHBOURHOOD = Kerrisdale

          spec
type         0   1
  basement   2   3
  duplex     0   2
  laneway   18   0
  single     7   0

, , NEIGHBOURHOOD = Killarney

          spec
type         0   1
  basement   6   2
  duplex     7  17
  laneway   49   9
  single     1   0

, , NEIGHBOURHOOD = Kitsilano

          spec
type         0   1
  basement  16   6
  duplex     4   2
  laneway   29  11
  single     9   2

, , NEIGHBOURHOOD = Knight

          spec
type         0   1
  basement  10   0
  duplex     3   7
  laneway   82  15
  single     1   0

, , NEIGHBOURHOOD = Main & Fraser

          spec
type         0   1
  basement  18   7
  duplex    11  16
  laneway   96  40
  single     5   0

, , NEIGHBOURHOOD = Marpole

          spec
type         0   1
  basement  12   0
  duplex     2   6
  laneway   44   8
  single     3   0

, , NEIGHBOURHOOD = Oakridge

          spec
type         0   1
  basement   2   0
  duplex     0   0
  laneway    3   3
  single     1   0

, , NEIGHBOURHOOD = Point Grey

          spec
type         0   1
  basement  27   3
  duplex     7   1
  laneway   58   6
  single    23   3

, , NEIGHBOURHOOD = Renfrew

          spec
type         0   1
  basement  19   2
  duplex    13  18
  laneway  147  51
  single     4   0

, , NEIGHBOURHOOD = Renfrew Heights

          spec
type         0   1
  basement   6   0
  duplex     4  13
  laneway   45  15
  single     0   0

, , NEIGHBOURHOOD = South Granville

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    0   0
  single     1   0

, , NEIGHBOURHOOD = South Vancouver

          spec
type         0   1
  basement  13   0
  duplex    14  21
  laneway  149  20
  single     0   0

, , NEIGHBOURHOOD = Southlands

          spec
type         0   1
  basement   1   0
  duplex     0   0
  laneway    0   0
  single     0   0

> print(table(d24[thirty==0 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,NEIGHBOURHOOD)]))
, , NEIGHBOURHOOD = Arbutus Ridge - Mackenzie Heights

          spec
type        0  1
  basement 10  0
  duplex    4  2
  laneway  31  0
  single   15  3

, , NEIGHBOURHOOD = Cambie

          spec
type        0  1
  basement  0  0
  duplex    7  0
  laneway   6  0
  single    1  0

, , NEIGHBOURHOOD = Cedar Cottage

          spec
type        0  1
  basement  0  2
  duplex   12  1
  laneway  13  0
  single    1  0

, , NEIGHBOURHOOD = Collingwood

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway  12  3
  single    0  0

, , NEIGHBOURHOOD = Dunbar

          spec
type        0  1
  basement  8  1
  duplex    0  0
  laneway  45  0
  single   11  1

, , NEIGHBOURHOOD = Fraserview

          spec
type        0  1
  basement  2  0
  duplex    2  2
  laneway  16  0
  single    0  0

, , NEIGHBOURHOOD = Grandview

          spec
type        0  1
  basement  0  0
  duplex    0  8
  laneway   0  0
  single    0  0

, , NEIGHBOURHOOD = Hastings East

          spec
type        0  1
  basement  0  0
  duplex   10  4
  laneway   7  2
  single    0  0

, , NEIGHBOURHOOD = Kerrisdale

          spec
type        0  1
  basement  7  0
  duplex    4  0
  laneway  13  4
  single   14  0

, , NEIGHBOURHOOD = Killarney

          spec
type        0  1
  basement  0  0
  duplex    0  4
  laneway   6 13
  single    0  0

, , NEIGHBOURHOOD = Kitsilano

          spec
type        0  1
  basement 11  0
  duplex    0  0
  laneway  22  0
  single    3  0

, , NEIGHBOURHOOD = Main & Fraser

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway  13  0
  single    0  0

, , NEIGHBOURHOOD = Marpole

          spec
type        0  1
  basement  0  0
  duplex    0  8
  laneway   0  0
  single    1  0

, , NEIGHBOURHOOD = Oakridge

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   3  0
  single    0  0

, , NEIGHBOURHOOD = Point Grey

          spec
type        0  1
  basement  7  0
  duplex    0  0
  laneway  22  0
  single    8  0

, , NEIGHBOURHOOD = Renfrew

          spec
type        0  1
  basement  0  0
  duplex    1 11
  laneway   9  0
  single    0  0

, , NEIGHBOURHOOD = Renfrew Heights

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   3  0
  single    0  0

, , NEIGHBOURHOOD = Shaughnessy

          spec
type        0  1
  basement  2  0
  duplex    0  0
  laneway   2  0
  single    0  0

, , NEIGHBOURHOOD = South Granville

          spec
type        0  1
  basement  5  0
  duplex    0  0
  laneway   9  0
  single    2  0

, , NEIGHBOURHOOD = South Vancouver

          spec
type        0  1
  basement  0  0
  duplex    4  0
  laneway  23  3
  single    0  0

, , NEIGHBOURHOOD = Southlands

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   5  0
  single    1  0

> 
> # Main regression
> # Dummy for spec vs custom on property type dummies and share 
> shares <- data.table(nbhd=character(),year=numeric(),thirty=integer(),type=character(),shareType=numeric(),typeSpec=numeric(),specShare=numeric(),priceLag=numeric())
> dsales <- fread("data/derived/sales.csv")
> dsales <- merge(dsales,d24[,.(ROLL_NUMBER24,MB_Year_Built,type,NEIGHBOURHOOD,thirty,spec)],by.x="ROLL_NUMBER",by.y="ROLL_NUMBER24")
> sales <- dsales[CONVEYANCE_DATE==MB_Year_Built | (CONVEYANCE_DATE==MB_Year_Built+1) ]
> for  (n in unique(dsales[,NEIGHBOURHOOD])) {
+ 	print(n)
+ 	print(dsales[NEIGHBOURHOOD==n & type=="duplex" & CONVEYANCE_DATE>2019 & thirty==1,CONVEYANCE_PRICE])
+ 	print(quantile(dsales[NEIGHBOURHOOD==n & type=="duplex" & CONVEYANCE_DATE>2019 & thirty==1,CONVEYANCE_PRICE],na.rm=TRUE))
+ }
[1] "Point Grey"
[1] 2184000   20710 2300000 2639375 1300000 1200000
     0%     25%     50%     75%    100% 
  20710 1225000 1742000 2271000 2639375 
[1] "Kitsilano"
 [1] 3188000 3188000 3188000 3188000 3188000 3188000 2250000 2360000 2540952
[10] 2585000 2476480      NA 2615000      NA 2050000 2050000 2030000 2080000
[19] 2498000
     0%     25%     50%     75%    100% 
2030000 2250000 2540952 3188000 3188000 
[1] "Dunbar"
[1] 2558000 2380000 2418000
     0%     25%     50%     75%    100% 
2380000 2399000 2418000 2488000 2558000 
[1] "Arbutus Ridge - Mackenzie Heights"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
[1] "Kerrisdale"
[1] 2188000 2138000
     0%     25%     50%     75%    100% 
2138000 2150500 2163000 2175500 2188000 
[1] "Southlands"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
[1] "Shaughnessy"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
[1] "Cambie"
 [1] 2200000 2200000 2200000 1563500 1563500 1563500 1563500 1020550 1020550
[10] 2188000 2188000 2188000 2188000 2024200 2024200 2024200 2024200
     0%     25%     50%     75%    100% 
1020550 1563500 2024200 2188000 2200000 
[1] "South Granville"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
[1] "Oakridge"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
[1] "Marpole"
 [1] 1971000 1971000 1971000 1715700 1715700 1715700 1971000 1971000 1971000
[10] 1724900 1724900 1724900 1860000 1860000 1860000 2000000 2000000 2000000
[19] 2280000 2280000 2068000 2068000 2068000 2000000 2000000 2000000   40000
[28]   40000  980000  980000
     0%     25%     50%     75%    100% 
  40000 1724900 1971000 2000000 2280000 
[1] "Grandview"
 [1] 1700000 1700000 1268300 1580000 1580000 1325000 1591750 1490000 1490476
[10] 1525000 1750000 1865000 1839800 1849000
     0%     25%     50%     75%    100% 
1268300 1499107 1585875 1737500 1865000 
[1] "Cedar Cottage"
[1] 1588000 1688000 2145000 2215000 1988000 1998000 1800000 1925000 1700000
     0%     25%     50%     75%    100% 
1588000 1700000 1925000 1998000 2215000 
[1] "Main & Fraser"
 [1] 1702000 1865000 1800000 1800000 1800000 1684600 1684600 1684600 1570000
[10] 1570000 1570000 1570000 1570000 1670000 1638000  821000  821000 1540000
[19] 1385000 1565000 1900000 1700000 1610000   33100   33100   33100 1655000
[28] 1655000 1655000 1348100 1348100 1348100 1642857 1875000 1830000 1850000
[37] 1680000 1680000 1680000  909200  909200  909200 1818400 1818400 1818400
[46] 2125000 2125000 1750000 1750000 1935000 1458000 1508000 1508000 1517000
[55] 1598000 1600000 1600000 1514000 1480000 1575000 1575000 1885000 1897000
[64] 1750000 1750000 1810000 1810000 1700000 1700000 1460000 1325000
     0%     25%     50%     75%    100% 
  33100 1511000 1655000 1775000 2125000 
[1] "South Vancouver"
 [1] 1125714 1125714 1125714 1440000 1440000 1440000 1231500 1231500 1550000
[10] 1550000 1360000 1523000 1550476 1569523 1350000 1350000 1388000 1388000
[19] 1494285 1590000 1500000 1450000 1412000 1900000 1650000 1700000 1700000
[28] 1680000 1680000 1148571 1148571 1281000 1281000 1609523 1609523 1720000
[37] 1800000 1713333 1276190 1300000 1070000 1070000 1070000 1388000 1388000
[46] 1400000 1400000 1450000
     0%     25%     50%     75%    100% 
1070000 1281000 1426000 1574642 1900000 
[1] "Knight"
 [1] 1550000 1555000 1420000 1420000 1050000 1050000 1224000 1309523 1331428
[10] 1525000 1525000 1245000 1245000 1219400 1219400    1976    1976    1976
[19]    1976 1615000 1615000 1615000 1505000 1650000 1680000 1630000 1630000
[28] 1630000  775000 1286000 1428571 1704001 1704001 1704001 1265000 1269000
[37] 1888000 1888000 1888000 1590000 1500000
     0%     25%     50%     75%    100% 
   1976 1245000 1500000 1630000 1888000 
[1] "Hastings East"
 [1] 1951000 1951000 1488000 1488000 1498000 1501900 1465000 1139500 1585000
[10] 1500000 1500000 1549900 1480000 1480000 1480000 1571428 1670000 1300000
[19] 1300000 1300000 1300000 1300000 1260000 1260000 1260000 1260000 1260000
[28] 1510000 1365000 1339000 1339000 1113900 1113900 1357142 1699000 1749000
[37] 2035000 2035000 1555000 1555000 1510000 1620000 1760000 1830000 1630000
[46] 1630000      NA      NA 1410000 1650000 1475000 1475000 1475000 1475000
[55] 1550000 1550000 1495238 1525000 1630000 1630000 1505000 1505000 1505000
[64] 1291500 1291500 1291500 1825000 1725000 1700000 1700000 1700000 1300400
[73] 1300400 1300400 1571428 1571428 1571428 1310000 1639000 1639000 1538095
[82] 1679000 1699000 1450000 1435000 1450000 1375000 1350000 1280000 1280000
[91] 1280000 1280000 1280000 1800000 1800000 1800000 1720000 1720000 1720000
     0%     25%     50%     75%    100% 
1113900 1310000 1500000 1639000 2035000 
[1] "Renfrew"
 [1] 1400000 1400000 1400000 1400000 1400000 1370000 1640000 1640000 1388000
[10] 1298000 2165000 2165000 1679000 1699900 1701888 1701888 1610000 1610000
[19] 1599000 1599000 1460000 1610000 1620000 1474000 1461000 1620000 1620000
[28] 1599000 1649000 1630000 1899000 1630000 1595000 1220000 1885000 1885000
[37] 1885000 1328200 1328200 1328200 1435000 1499000 1385000 1385000 1385000
[46] 1200000 1635000 1635000 1685000 1685000 1250000 1250000 1198000 1240000
[55] 1660000 1675000 1450000 1450000 1450000 1706000 1799000 1768000 1768000
[64] 1768000 1545000 1545000 1545000 1650000 1650000 1350000 1350000 1725000
[73] 1725000 1725000 1305800 1305800 1305800 1380000 1430000 1413000 1408000
[82] 1295500 1295500 1430000 1550000 1487500 1487500 1252380 1580000 1265000
[91] 1250000
     0%     25%     50%     75%    100% 
1198000 1385000 1545000 1650000 2165000 
[1] "Renfrew Heights"
 [1] 1620000 1665000 1439000 1439000 1439000 1434000 1434000 1434000 1982000
[10] 1982000 1982000 1265000 1265000 1265000 1301000 1301000 1301000 1301000
[19] 1301000 1100000 1100000 1100000 1100000 1100000 1548000 1548000 1300000
[28] 1300000 1535000 1529000 1400000 1400000 1400000 1050000 1137700
     0%     25%     50%     75%    100% 
1050000 1265000 1400000 1484000 1982000 
[1] "Collingwood"
 [1] 1500000 1580000 1352380 1410000 1175700 1595238 1595238 1410000 1410000
[10] 1175700 1175700 1438000 1438000 1208600 1208600 1220000 1220000 1428571
[19] 1428571 1600000 1600000 1790000 1790000 1790000 3300000 3300000 1330000
[28] 1330000 1188000
     0%     25%     50%     75%    100% 
1175700 1220000 1428571 1595238 3300000 
[1] "Killarney"
 [1] 1350000 1350000 1350000 1350000 1350000 1549000 1230500 1500000 1500000
[10] 1333333 1333333 1418000 1418000 1322857 1322857 1495238 1420000 1210000
[19] 1485714 1485714 1460000 1590000 1540000  789000  789000  789000  789000
[28]  789000  789000 1675000 1675000 1675000 1095238 1333333 1333333 1400000
[37] 1657142 1657142 1237142 1237142 1238095 1238095
     0%     25%     50%     75%    100% 
 789000 1237380 1350000 1492857 1675000 
[1] "Fraserview"
integer(0)
  0%  25%  50%  75% 100% 
  NA   NA   NA   NA   NA 
> KEEPLAG <- 1
> for (y in seq(FIRST_BUILT,LAST_BUILT)) {
+ 	for (n in unique(d24$NEIGHBOURHOOD)) {
+ 		for (s in c(0,1)) { #consider 50', too
+ 		#for (s in c(1)) {
+ 			dsub <- d24[NEIGHBOURHOOD==n & MB_Year_Built==y & thirty==s  ]
+ 			for (t in c("single","duplex","laneway","basement")) {
+ 			#for (t in c("single","laneway","basement")) {
+ 				dss <- dsales[CONVEYANCE_TYPE_DESCRIPTION=="Improved Single Property Transaction" & NEIGHBOURHOOD==n & CONVEYANCE_DATE<y & CONVEYANCE_DATE>=(y-KEEPLAG) & thirty==s & type==t]
+ 				shares <- rbind(shares,data.table(nbhd=n,year=y,thirty=s,type=t,shareType=dsub[,mean(type==t)],typeSpec=dsub[type==t,mean(spec==1)],specShare=dsub[spec==1,mean(type==t)],priceLag=dss[,log(median(CONVEYANCE_PRICE,na.rm=TRUE))]))
+ 			}
+ 		    }
+         }
+ }

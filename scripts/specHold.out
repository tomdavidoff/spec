
R version 4.4.0 (2024-04-24) -- "Puppy Cup"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # specHold.R 
> # how long to spec builders hold properties?
> # Also, when do they buy?
> # Tom Davidoff
> # 06/04/25
> 
> # strategy: find last sale before year built for single family homes
> # consider doing for all teardowns class of 2016, but see how long hold is first
> # do this for each metro area
> 
> library(data.table)
> library(fixest)	
> library(RSQLite)
> library(ggplot2)
> 
> # get dates of construction for single family homes 
> # see if roll number ends in zero and no other by lot start works
> 
> DOCOMPILE <- FALSE
> 
> if (DOCOMPILE==TRUE) {
+ 	dd25 <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",select=c("JURISDICTION_CODE","ROLL_NUMBER","FOLIO_ID","ACTUAL_USE_DESCRIPTION","REGIONAL_DISTRICT"),colClasses=c(ROLL_NUMBER="character"))
+ 	print(summary(dd25))
+ 	print(summary(dd25))
+ 	dj25 <- unique(dd25[,.(JURISDICTION_CODE,ROLL_NUMBER,FOLIO_ID)]) # for sales data uniformity
+ 	print(dj25[1:20])
+ 	names(dj25) <- c("JURISDICTION_CODE","ROLL_NUMBER","FOLIO_ID")
+ 	print(dj25[1:20])
+ 
+ 	diri <- "~/OneDrive - UBC/Documents/data/bca/Residential_inventory_202501/"
+ 	dirf <- list.files(diri)
+ 
+ 	di25 <- data.table(Jurisdiction=numeric(),Roll_Number=character(),MB_Year_Built=numeric(),MB_Effective_Year=numeric())
+ 	for (f in paste0(diri,dirf)) {
+ 		d <- fread(f,select=c("Jurisdiction","Roll_Number","MB_Year_Built","MB_Effective_Year"),colClasses=c(Roll_Number="character",Jurisdiction="numeric") )
+ 		di25 <- rbind(di25,d)
+ 	}
+ 	di25 <- di25[!is.na(MB_Year_Built)]
+ 	# to date 20250312000000
+ 
+ 	d25 <- merge(dd25,di25,by.x=c("JURISDICTION_CODE","ROLL_NUMBER"),by.y=c("Jurisdiction","Roll_Number"))
+ 	print(summary(d25))
+ 
+ 	ds25 <- fread("~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_sales_20250331_REVD25.csv",select=c("FOLIO_ID","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"),colClasses=c(CONVEYANCE_DATE="character"))
+ 	# convert folioID to jurisdiction/roll_number as pre-redevelopment sales will have often same jurisd/roll_number, different FOLIO_ID. Certainly same rollStart
+ 	ds25[,CONVEYANCE_DATE:=as.Date(CONVEYANCE_DATE,format="%Y%m%d%H%M%S")]
+ 	print("probnlem 25")
+ 	print(summary(ds25))
+ 	print(summary(dj25))
+ 	print(ds25[1:10])
+ 	print(dj25[1:10])
+ 	ds25 <- merge(ds25,dj25,by="FOLIO_ID") # add jurisdiction code and roll number
+ 
+ 	# get sales data from 2016 to maximize chain of sales
+ 	# open an sqlite connection to ~/docs/data/bca/REVD16_and_inventory_extracts.sqlite3
+ 
+ 	# get only single family lots as of 2016
+ 	db16 <- dbConnect(RSQLite::SQLite(), "~/OneDrive - UBC/Documents/data/bca/REVD16_and_inventory_extracts.sqlite3")
+ 	df16 <- dbGetQuery(db16, "SELECT folioID, jurisdictionCode, rollNumber FROM folio") 
+ 	du16 <- dbGetQuery(db16, "SELECT folioID FROM folioDescription WHERE actualUseDescription IN ('Single Family Dwelling','Residential Dwelling with Suite')") #1.	“Single Family Dwelling” and “Residential Dwelling with Suite” are almost certainly SFHs. from ChatGPT, and is right_use
+ 	du16 <- data.table(du16) # convert to data.table
+ 	names(du16) <- "folioID" # rename to folioID
+ 	df16 <- data.table(merge(df16,du16,by="folioID")) # keep only the valid single family
+ 	# verify last digit of roll number is always zero, and only one observation per rollStart
+ 	df16[,rollStart:=substring(rollNumber,1,nchar(rollNumber)-1)]
+ 	print(summary(df16[,.N,by=rollStart]))
+ 	# now the last digit thing
+ 	df16[,lastDigit:=substring(rollNumber,nchar(rollNumber),nchar(rollNumber))]
+ 	print(table(df16[,lastDigit])) # not true always 1
+ 	df16[,lastDigit:=NULL]
+ 	df16[,ner:=.N,by=c("rollStart","jurisdictionCode")] 
+ 	print(df16[ner>1]) # these seem to be luxury
+ 	print(table(df16[,ner]))
+ 	df16 <- df16[ner==1]
+ 	df16[,ner:=NULL] # drop count
+ 	ds16 <- dbGetQuery(db16, "SELECT folioID, conveyanceDate, conveyancePrice, conveyanceTypeDescription FROM sales")
+ 	print(summary(df16))
+ 	print(summary(ds16))
+ 	print("DD?")
+ 	ds16 <- data.table(merge(df16,ds16,by="folioID"))
+ 	ds16[,folioID:=NULL] # drop folioID
+ 	setnames(ds16,c("jurisdictionCode","rollNumber","conveyanceDate","conveyancePrice","conveyanceTypeDescription"),c("JURISDICTION_CODE","ROLL_NUMBER","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"))
+ 	print(ds16[1:10,CONVEYANCE_DATE])
+ 	ds16[,CONVEYANCE_DATE:=as.Date(CONVEYANCE_DATE,format="%Y-%m-%d")]
+ 	print("ds16then25")
+ 	print(ds16[1:20,])
+ 	print(summary(ds25))
+ 	print(ds25[1:20])
+ 	ds25[,FOLIO_ID:=NULL] # drop FOLIO_ID
+ 	ds25[,rollStart:=substring(ROLL_NUMBER,1,nchar(ROLL_NUMBER)-1)] # create rollStart
+ 	ds16[,in16:=1] # mark as in 2016
+ 	ds25[,in16:=0] # mark as not in 2016
+ 	print("namediff")
+ 	# only want stuff that had roll start in 2016
+ 	ds25 <- unique(rbind(ds25,ds16)) # note this procedure should allow duplexes as of 2025 -- but also note in 16 makes unique not happen
+ 	ds25[,max16:=max(in16),by=c("JURISDICTION_CODE","rollStart")]
+ 	ds25 <- ds25[max16==1] # keep only those with a 2016 sale
+ 	ds25[,max16:=NULL] # drop max16 now redundant
+ 	ds25[,in16:=NULL] # drop in16 now redundant
+ 	ds25 <- ds25[CONVEYANCE_TYPE_DESCRIPTION=="Improved Single Property Transaction"]
+ 	ds25[,CONVEYANCE_TYPE_DESCRIPTION:=NULL] # drop conveyance type description now redundant
+ 	print("winner!")
+ 	ds25[,JURISDICTION_CODE:=as.numeric(JURISDICTION_CODE)]
+ 	print(d25[1:20,])
+ 	print(ds25[1:20,])
+ 	print(table(d25[,JURISDICTION_CODE]))
+ 	d25[,rollStart:=substring(ROLL_NUMBER,1,nchar(ROLL_NUMBER)-1)]
+ 	print(names(d25))
+ 	print(summary(d25))
+ 	d25[,maxBuilt:=max(MB_Year_Built),by=c("JURISDICTION_CODE","rollStart")] # in case of e.g. duplexes
+ 	d25[,lastDigit:=substring(ROLL_NUMBER,nchar(ROLL_NUMBER),nchar(ROLL_NUMBER))]	
+ 	d25[,minLastDigit:=min(lastDigit),by=c("JURISDICTION_CODE","rollStart")]
+ 	d25 <- d25[lastDigit==minLastDigit] # keep only lowest digit of set in event multiple same year built
+ 	print(summary(d25))
+ 	d25 <- d25[MB_Year_Built == maxBuilt] # drop earlier of duplexes if any
+ 	setnames(ds25,"ROLL_NUMBER","rollSales") # rename roll number to rollSales
+ 	d25 <- merge(d25,ds25,by=c("JURISDICTION_CODE","rollStart")) # add sales data
+ 	print(summary(d25))
+ 	d25[,nRoll:=.N,by=rollStart]
+ 	print(table(d25[,nRoll]))
+ 
+ 	fwrite(d25,"data/derived/specHold25.csv")
+ 
+ }
> 
> d25 <- fread("data/derived/specHold25.csv")
> d25 <- unique(d25) # shouldn't be, but are duplicates
> 
> # how to observe prior sales?
> 
> PUNISHMENT <- 10^9
> print(PUNISHMENT)
[1] 1e+09
> # reshape to horizontal with dcast to see all three sales
> print(summary(d25))
 JURISDICTION_CODE  rollStart         ROLL_NUMBER          FOLIO_ID        
 Min.   :200.0     Length:1239036     Length:1239036     Length:1239036    
 1st Qu.:226.0     Class :character   Class :character   Class :character  
 Median :311.0     Mode  :character   Mode  :character   Mode  :character  
 Mean   :323.3                                                             
 3rd Qu.:326.0                                                             
 Max.   :789.0                                                             
                                                                           
 ACTUAL_USE_DESCRIPTION REGIONAL_DISTRICT  MB_Year_Built  MB_Effective_Year
 Length:1239036         Length:1239036     Min.   :   0   Min.   :   0     
 Class :character       Class :character   1st Qu.:1960   1st Qu.:1975     
 Mode  :character       Mode  :character   Median :1976   Median :1986     
                                           Mean   :1975   Mean   :1985     
                                           3rd Qu.:1991   3rd Qu.:1997     
                                           Max.   :2024   Max.   :2024     
                                                          NA's   :11       
    maxBuilt     lastDigit         minLastDigit       CONVEYANCE_DATE     
 Min.   :   0   Length:1239036     Length:1239036     Min.   :1902-04-30  
 1st Qu.:1960   Class :character   Class :character   1st Qu.:1991-12-06  
 Median :1976   Mode  :character   Mode  :character   Median :2003-03-31  
 Mean   :1975                                         Mean   :2002-01-25  
 3rd Qu.:1991                                         3rd Qu.:2013-04-02  
 Max.   :2024                                         Max.   :2025-03-12  
                                                                          
 CONVEYANCE_PRICE     rollSales             nRoll       
 Min.   :        0   Length:1239036     Min.   :  1.00  
 1st Qu.:   132000   Class :character   1st Qu.:  4.00  
 Median :   281500   Mode  :character   Median :  6.00  
 Mean   :   497263                      Mean   : 10.74  
 3rd Qu.:   580000                      3rd Qu.:  6.00  
 Max.   :660000000                      Max.   :154.00  
 NA's   :103                                            
> d25[,firstPost:=min(CONVEYANCE_DATE+PUNISHMENT*(year(CONVEYANCE_DATE) < MB_Year_Built)),by=c("JURISDICTION_CODE","rollStart")] # first sale post-construction but what if tie? see saleYearBuilt stuff
> d25[,saleYearBuilt:=year(CONVEYANCE_DATE)==MB_Year_Built]
> d25[,nSaleYearBuilt:=sum(saleYearBuilt),by="FOLIO_ID"]
> print(table(d25[,nSaleYearBuilt])) # how many sales in year built typically

      0       1       2       3       4       5       6       7       8       9 
1101741  128368    7438     573     507     117     103      82      43      53 
     10 
     11 
> d25[,lastSaleYearBuilt:=0]
> d25[nSaleYearBuilt>1,lastSaleYearBuilt:=max(CONVEYANCE_DATE),by=c("JURISDICTION_CODE","rollStart")] # last sale in year built
> d25[nSaleYearBuilt>1,firstPost:=lastSaleYearBuilt] # if multiple sales in year built, use last sale in year built and this assumes spec
> d25[,preDate:=as.Date("1600-01-01",format="%Y-%m-%d")] # last sale before year built
> d25[CONVEYANCE_DATE < firstPost, preDate:=CONVEYANCE_DATE] 
> d25[,lastPre:=max(preDate),by=FOLIO_ID]
> d25[,yfpost:=year(firstPost)]
> d25[,lastSale:=max(CONVEYANCE_DATE),by="FOLIO_ID"] # last sale date
> print(summary(d25))
 JURISDICTION_CODE  rollStart         ROLL_NUMBER          FOLIO_ID        
 Min.   :200.0     Length:1239036     Length:1239036     Length:1239036    
 1st Qu.:226.0     Class :character   Class :character   Class :character  
 Median :311.0     Mode  :character   Mode  :character   Mode  :character  
 Mean   :323.3                                                             
 3rd Qu.:326.0                                                             
 Max.   :789.0                                                             
                                                                           
 ACTUAL_USE_DESCRIPTION REGIONAL_DISTRICT  MB_Year_Built  MB_Effective_Year
 Length:1239036         Length:1239036     Min.   :   0   Min.   :   0     
 Class :character       Class :character   1st Qu.:1960   1st Qu.:1975     
 Mode  :character       Mode  :character   Median :1976   Median :1986     
                                           Mean   :1975   Mean   :1985     
                                           3rd Qu.:1991   3rd Qu.:1997     
                                           Max.   :2024   Max.   :2024     
                                                          NA's   :11       
    maxBuilt     lastDigit         minLastDigit       CONVEYANCE_DATE     
 Min.   :   0   Length:1239036     Length:1239036     Min.   :1902-04-30  
 1st Qu.:1960   Class :character   Class :character   1st Qu.:1991-12-06  
 Median :1976   Mode  :character   Mode  :character   Median :2003-03-31  
 Mean   :1975                                         Mean   :2002-01-25  
 3rd Qu.:1991                                         3rd Qu.:2013-04-02  
 Max.   :2024                                         Max.   :2025-03-12  
                                                                          
 CONVEYANCE_PRICE     rollSales             nRoll       
 Min.   :        0   Length:1239036     Min.   :  1.00  
 1st Qu.:   132000   Class :character   1st Qu.:  4.00  
 Median :   281500   Mode  :character   Median :  6.00  
 Mean   :   497263                      Mean   : 10.74  
 3rd Qu.:   580000                      3rd Qu.:  6.00  
 Max.   :660000000                      Max.   :154.00  
 NA's   :103                                            
   firstPost             saleYearBuilt   nSaleYearBuilt    lastSaleYearBuilt 
 Min.   :1920-05-15      Mode :logical   Min.   : 0.0000   Min.   :    0.00  
 1st Qu.:1987-10-02      FALSE:1178346   1st Qu.: 0.0000   1st Qu.:    0.00  
 Median :1995-12-28      TRUE :60690     Median : 0.0000   Median :    0.00  
 Mean   :134938-03-24                    Mean   : 0.1208   Mean   :   96.91  
 3rd Qu.:2006-01-31                      3rd Qu.: 0.0000   3rd Qu.:    0.00  
 Max.   :2739930-11-18                   Max.   :10.0000   Max.   :20158.00  
                                                                             
    preDate              lastPre               yfpost       
 Min.   :1600-01-01   Min.   :1600-01-01   Min.   :   1920  
 1st Qu.:1600-01-01   1st Qu.:1600-01-01   1st Qu.:   1987  
 Median :1600-01-01   Median :1600-01-01   Median :   1995  
 Mean   :1635-07-06   Mean   :1651-07-04   Mean   : 134938  
 3rd Qu.:1600-01-01   3rd Qu.:1600-01-01   3rd Qu.:   2006  
 Max.   :2025-02-19   Max.   :2025-02-19   Max.   :2739930  
                                                            
    lastSale         
 Min.   :1902-04-30  
 1st Qu.:2002-10-31  
 Median :2014-03-03  
 Mean   :2010-06-24  
 3rd Qu.:2020-08-31  
 Max.   :2025-03-12  
                     
> d25[,spec:=yfpost < (MB_Year_Built+2)]
> d25[,specBuy:=(CONVEYANCE_DATE==lastPre)*spec] # spec buy is last sale before year built
> d25[,specSale:=(CONVEYANCE_DATE==firstPost)*spec] # spec sale is first sale after year built
> print(table(d25[specBuy==1,MB_Year_Built-year(CONVEYANCE_DATE)])) # approximates how long spec builders held ; last sale to one per obs

  -1    0    1    2    3    4    5    6    7    8    9   10   11   12   13   14 
  16 1219 4099 1172  666  524  421  324  338  286  249  234  230  195  158  171 
  15   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30 
 156  108   88  110   99   92   70   79   73   83   72   78   77   54   57   53 
  31   32   33   34   35   36   37   38   39   40   41   42   43   44   45   46 
  42   47   44   45   42   19   33   34   18   31    9   13   13   14   11   15 
  47   48   49   50   51   52   56   67   71 
  14    6    5    1    1    1    1    2    1 
> print(table(d25[specSale==1 & (JURISDICTION_CODE==200),MB_Year_Built-year(CONVEYANCE_DATE)])) # approximates how long spec builders held

  -1    0 
5282 8205 
> 
> # which years did they buy?
> print(table(d25[specBuy==1,year(lastPre)]))

1908 1911 1957 1963 1964 1966 1967 1968 1969 1970 1971 1972 1973 1974 1975 1976 
   1    2    1    1    2    1    1    1    1    2   25   40   44  287  288  360 
1977 1978 1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 
 337  302  374  208  135  141  214  155  197  245  301  381  454  269  306  373 
1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2008 
 337  268  164  193  220  153  196  126  178  246  303  232  241  253  293  146 
2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2020 2021 2022 2023 2024 
 172  256  381  270  264  372  376  382  148   87   70   89  113   58   40   32 
2025 
   5 
> print(table(d25[specBuy==1,yearmon(lastPre)]))

1908.58333333333          1911.75 1957.83333333333           1963.5 
               1                2                1                1 
         1964.25          1964.75          1966.25 1967.66666666667 
               1                1                1                1 
1968.41666666667 1969.33333333333          1970.25 1970.66666666667 
               1                1                1                1 
            1971          1971.25           1971.5          1971.75 
               3                9                3               10 
            1972 1972.08333333333          1972.25 1972.33333333333 
               2                1                7                1 
          1972.5          1972.75 1972.83333333333 1972.91666666667 
              13               10                2                4 
            1973          1973.25 1973.41666666667           1973.5 
               5               12                1               19 
         1973.75 1973.83333333333             1974 1974.08333333333 
               6                1               74                1 
1974.16666666667          1974.25           1974.5          1974.75 
               1               95               58               57 
1974.91666666667             1975 1975.08333333333          1975.25 
               1               39                1               73 
1975.33333333333           1975.5 1975.58333333333 1975.66666666667 
               3               73                3                7 
         1975.75 1975.83333333333 1975.91666666667             1976 
              57                9               23               18 
1976.08333333333 1976.16666666667          1976.25 1976.33333333333 
              24               33               25               33 
1976.41666666667           1976.5 1976.58333333333 1976.66666666667 
              40               28               40               22 
         1976.75 1976.83333333333 1976.91666666667             1977 
              28               38               31               14 
1977.08333333333 1977.16666666667          1977.25 1977.33333333333 
              24               28               29               25 
1977.41666666667           1977.5 1977.58333333333 1977.66666666667 
              36               27               24               33 
         1977.75 1977.83333333333 1977.91666666667             1978 
              38               23               36               21 
1978.08333333333 1978.16666666667          1978.25 1978.33333333333 
              12               24               22               19 
1978.41666666667           1978.5 1978.58333333333 1978.66666666667 
              21               31               29               35 
         1978.75 1978.83333333333 1978.91666666667             1979 
              20               37               31               18 
1979.08333333333 1979.16666666667          1979.25 1979.33333333333 
              13               24               24               40 
1979.41666666667           1979.5 1979.58333333333 1979.66666666667 
              21               44               41               40 
         1979.75 1979.83333333333 1979.91666666667             1980 
              43               41               25                8 
1980.08333333333 1980.16666666667          1980.25 1980.33333333333 
               8               16               13               12 
1980.41666666667           1980.5 1980.58333333333 1980.66666666667 
              10               15               22               30 
         1980.75 1980.83333333333 1980.91666666667             1981 
              21               24               29               17 
1981.08333333333 1981.16666666667          1981.25 1981.33333333333 
              15               17               12               16 
1981.41666666667           1981.5 1981.58333333333 1981.66666666667 
               6               11                8                7 
         1981.75 1981.83333333333 1981.91666666667             1982 
               9                9                8                5 
1982.08333333333 1982.16666666667          1982.25 1982.33333333333 
               5                4                5                7 
1982.41666666667           1982.5 1982.58333333333 1982.66666666667 
              15                7               16               12 
         1982.75 1982.83333333333 1982.91666666667             1983 
              19               21               25                9 
1983.08333333333 1983.16666666667          1983.25 1983.33333333333 
              21               31               18               17 
1983.41666666667           1983.5 1983.58333333333 1983.66666666667 
              29               15               13               16 
         1983.75 1983.83333333333 1983.91666666667             1984 
              24                9               12                9 
1984.08333333333 1984.16666666667          1984.25 1984.33333333333 
              15               20               13               13 
1984.41666666667           1984.5 1984.58333333333 1984.66666666667 
              14               14                9               17 
         1984.75 1984.83333333333 1984.91666666667             1985 
              11               12                8               12 
1985.08333333333 1985.16666666667          1985.25 1985.33333333333 
               7               21               14               19 
1985.41666666667           1985.5 1985.58333333333 1985.66666666667 
              14               10               12               16 
         1985.75 1985.83333333333 1985.91666666667             1986 
              25               26               21               16 
1986.08333333333 1986.16666666667          1986.25 1986.33333333333 
              13               15               27               15 
1986.41666666667           1986.5 1986.58333333333 1986.66666666667 
              16               15               19               13 
         1986.75 1986.83333333333 1986.91666666667             1987 
              33               30               33               18 
1987.08333333333 1987.16666666667          1987.25 1987.33333333333 
              21               32               31               28 
1987.41666666667           1987.5 1987.58333333333 1987.66666666667 
              23               19               22               20 
         1987.75 1987.83333333333 1987.91666666667             1988 
              36               24               27               24 
1988.08333333333 1988.16666666667          1988.25 1988.33333333333 
              19               25               24               38 
1988.41666666667           1988.5 1988.58333333333 1988.66666666667 
              35               33               36               39 
         1988.75 1988.83333333333 1988.91666666667             1989 
              39               26               43               26 
1989.08333333333 1989.16666666667          1989.25 1989.33333333333 
              32               49               47               34 
1989.41666666667           1989.5 1989.58333333333 1989.66666666667 
              42               25               37               37 
         1989.75 1989.83333333333 1989.91666666667             1990 
              40               49               36               26 
1990.08333333333 1990.16666666667          1990.25 1990.33333333333 
              27               28               23               11 
1990.41666666667           1990.5 1990.58333333333 1990.66666666667 
              20               11               19               22 
         1990.75 1990.83333333333 1990.91666666667             1991 
              21               22               39               10 
1991.08333333333 1991.16666666667          1991.25 1991.33333333333 
              14               16               36               47 
1991.41666666667           1991.5 1991.58333333333 1991.66666666667 
              38               24               30               23 
         1991.75 1991.83333333333 1991.91666666667             1992 
              32               20               16               16 
1992.08333333333 1992.16666666667          1992.25 1992.33333333333 
              25               24               25               33 
1992.41666666667           1992.5 1992.58333333333 1992.66666666667 
              27               25               39               30 
         1992.75 1992.83333333333 1992.91666666667             1993 
              41               50               38               19 
1993.08333333333 1993.16666666667          1993.25 1993.33333333333 
              15               33               23               25 
1993.41666666667           1993.5 1993.58333333333 1993.66666666667 
              35               40               23               35 
         1993.75 1993.83333333333 1993.91666666667             1994 
              34               23               32               15 
1994.08333333333 1994.16666666667          1994.25 1994.33333333333 
              22               16               24               34 
1994.41666666667           1994.5 1994.58333333333 1994.66666666667 
              24               16               22               22 
         1994.75 1994.83333333333 1994.91666666667             1995 
              17               28               28               12 
1995.08333333333 1995.16666666667          1995.25 1995.33333333333 
              11               14                7               16 
1995.41666666667           1995.5 1995.58333333333 1995.66666666667 
              11               15               19               13 
         1995.75 1995.83333333333 1995.91666666667             1996 
              13               21               12               15 
1996.08333333333 1996.16666666667          1996.25 1996.33333333333 
              10                9               24               19 
1996.41666666667           1996.5 1996.58333333333 1996.66666666667 
              11               15               14               15 
         1996.75 1996.83333333333 1996.91666666667             1997 
              26               18               17                8 
1997.08333333333 1997.16666666667          1997.25 1997.33333333333 
              17               11               20               17 
1997.41666666667           1997.5 1997.58333333333 1997.66666666667 
              20               20               13               20 
         1997.75 1997.83333333333 1997.91666666667             1998 
              25               31               18               14 
1998.08333333333 1998.16666666667          1998.25 1998.33333333333 
               7                7               13               16 
1998.41666666667           1998.5 1998.58333333333 1998.66666666667 
              13               12               13               12 
         1998.75 1998.83333333333 1998.91666666667             1999 
              11               17               18                6 
1999.08333333333 1999.16666666667          1999.25 1999.33333333333 
              10               16               16               15 
1999.41666666667           1999.5 1999.58333333333 1999.66666666667 
              22               12               14               16 
         1999.75 1999.83333333333 1999.91666666667             2000 
              25               25               19                5 
2000.08333333333 2000.16666666667          2000.25 2000.33333333333 
               5                6                6               15 
2000.41666666667           2000.5 2000.58333333333 2000.66666666667 
              12                7               18                9 
         2000.75 2000.83333333333 2000.91666666667             2001 
              22               12                9                5 
2001.08333333333 2001.16666666667          2001.25 2001.33333333333 
              10               12               10               16 
2001.41666666667           2001.5 2001.58333333333 2001.66666666667 
              12               15               23               21 
         2001.75 2001.83333333333 2001.91666666667             2002 
              19               17               18               15 
2002.08333333333 2002.16666666667          2002.25 2002.33333333333 
              17                9               15               18 
2002.41666666667           2002.5 2002.58333333333 2002.66666666667 
              22               27               25               24 
         2002.75 2002.83333333333 2002.91666666667             2003 
              26               31               17               14 
2003.08333333333 2003.16666666667          2003.25 2003.33333333333 
              16               12               18               22 
2003.41666666667           2003.5 2003.58333333333 2003.66666666667 
              17               27               29               38 
         2003.75 2003.83333333333 2003.91666666667             2004 
              50               34               26                8 
2004.08333333333 2004.16666666667          2004.25 2004.33333333333 
              15               12               16               21 
2004.41666666667           2004.5 2004.58333333333 2004.66666666667 
              31               19               15               19 
         2004.75 2004.83333333333 2004.91666666667             2005 
              28               32               16               13 
2005.08333333333 2005.16666666667          2005.25 2005.33333333333 
               9               11               16               16 
2005.41666666667           2005.5 2005.58333333333 2005.66666666667 
              20               20               35               28 
         2005.75 2005.83333333333 2005.91666666667             2006 
              31               25               17               22 
2006.08333333333 2006.16666666667          2006.25 2006.33333333333 
               7               18               14               24 
2006.41666666667           2006.5 2006.58333333333 2006.66666666667 
              30               30               29               24 
         2006.75 2006.83333333333 2006.91666666667             2007 
              17               20               18               17 
2007.08333333333 2007.16666666667          2007.25 2007.33333333333 
               9                9               16               24 
2007.41666666667           2007.5 2007.58333333333 2007.66666666667 
              29               37               35               25 
         2007.75 2007.83333333333 2007.91666666667             2008 
              35               35               22               10 
2008.08333333333 2008.16666666667          2008.25 2008.33333333333 
              10               11               24               19 
2008.41666666667           2008.5 2008.58333333333 2008.66666666667 
              10               17                8               14 
         2008.75 2008.83333333333 2008.91666666667             2009 
              13                6                4                1 
2009.08333333333 2009.16666666667          2009.25 2009.33333333333 
               5                5                5               11 
2009.41666666667           2009.5 2009.58333333333 2009.66666666667 
              14               18               17               30 
         2009.75 2009.83333333333 2009.91666666667             2010 
              25               30               11                7 
2010.08333333333 2010.16666666667          2010.25 2010.33333333333 
               9               16               21               29 
2010.41666666667           2010.5 2010.58333333333 2010.66666666667 
              36               23               23               27 
         2010.75 2010.83333333333 2010.91666666667             2011 
              26               28               11               15 
2011.08333333333 2011.16666666667          2011.25 2011.33333333333 
              16               29               21               36 
2011.41666666667           2011.5 2011.58333333333 2011.66666666667 
              38               39               32               45 
         2011.75 2011.83333333333 2011.91666666667             2012 
              44               38               28               12 
2012.08333333333 2012.16666666667          2012.25 2012.33333333333 
              21               17               24               27 
2012.41666666667           2012.5 2012.58333333333 2012.66666666667 
              22               37               24               18 
         2012.75 2012.83333333333 2012.91666666667             2013 
              26               25               17               12 
2013.08333333333 2013.16666666667          2013.25 2013.33333333333 
              13               10               20               18 
2013.41666666667           2013.5 2013.58333333333 2013.66666666667 
              12               21               38               28 
         2013.75 2013.83333333333 2013.91666666667             2014 
              32               36               24               14 
2014.08333333333 2014.16666666667          2014.25 2014.33333333333 
              15               10               31               33 
2014.41666666667           2014.5 2014.58333333333 2014.66666666667 
              50               46               58               32 
         2014.75 2014.83333333333 2014.91666666667             2015 
              30               31               22               20 
2015.08333333333 2015.16666666667          2015.25 2015.33333333333 
              14               21               28               28 
2015.41666666667           2015.5 2015.58333333333 2015.66666666667 
              37               43               41               39 
         2015.75 2015.83333333333 2015.91666666667             2016 
              44               29               32               18 
2016.08333333333 2016.16666666667          2016.25 2016.33333333333 
              27               31               34               54 
2016.41666666667           2016.5 2016.58333333333 2016.66666666667 
              49               48               37               26 
         2016.75 2016.83333333333 2016.91666666667             2017 
              20               21               17                8 
2017.08333333333 2017.16666666667          2017.25 2017.33333333333 
               3               11                6               17 
2017.41666666667           2017.5 2017.58333333333 2017.66666666667 
              17               14               17               17 
         2017.75 2017.83333333333 2017.91666666667             2018 
              13               16                9                8 
2018.08333333333 2018.16666666667          2018.25 2018.33333333333 
               8               11                9                8 
2018.41666666667           2018.5 2018.58333333333 2018.66666666667 
               7                6                8                8 
         2018.75 2018.83333333333 2018.91666666667             2019 
               6                5                3                2 
2019.08333333333          2019.25 2019.33333333333 2019.41666666667 
               2                8                8               10 
          2019.5 2019.58333333333 2019.66666666667          2019.75 
               5                6                5                9 
2019.83333333333 2019.91666666667             2020 2020.08333333333 
               7                8                6                4 
2020.16666666667          2020.25 2020.33333333333 2020.41666666667 
               1                3                8                3 
          2020.5 2020.58333333333 2020.66666666667          2020.75 
               6               10               17               15 
2020.83333333333 2020.91666666667             2021 2021.08333333333 
              10                6                2                4 
2021.16666666667          2021.25 2021.33333333333 2021.41666666667 
               7                8               14               15 
          2021.5 2021.58333333333 2021.66666666667          2021.75 
               9               10               17               13 
2021.83333333333 2021.91666666667             2022 2022.08333333333 
               8                6                3                3 
2022.16666666667          2022.25 2022.33333333333 2022.41666666667 
               5                6                6                8 
          2022.5 2022.58333333333 2022.66666666667          2022.75 
               1                4                6                3 
2022.83333333333 2022.91666666667             2023 2023.08333333333 
               8                5                1                1 
2023.16666666667          2023.25 2023.33333333333 2023.41666666667 
               4                3                4                5 
          2023.5 2023.58333333333 2023.66666666667          2023.75 
               1                3                3                3 
2023.83333333333 2023.91666666667 2024.08333333333 2024.16666666667 
              10                2                8                1 
         2024.25 2024.33333333333 2024.41666666667           2024.5 
               2                2                4                2 
2024.58333333333 2024.66666666667          2024.75 2024.83333333333 
               3                1                4                3 
2024.91666666667             2025 2025.08333333333 
               2                4                1 
> 
> # create a price index just metro Vancouver
> # Deflate prices by CPI
> dc <- fread("data/raw/statCanCPIwm.csv",select=c("REF_DATE","VALUE"))
> setnames(dc,"VALUE","CPI") # rename value to CPI
> dc[,year:=as.numeric(substring(REF_DATE,1,4))] # extract year from REF_DATE
> dc[,month:=as.numeric(substring(REF_DATE,6,7))] # extract month from REF_DATE
> print(dc)
     REF_DATE   CPI  year month
       <char> <num> <num> <num>
  1:  1989-12 104.2  1989    12
  2:  1990-01 104.7  1990     1
  3:  1990-02 104.9  1990     2
  4:  1990-03 105.3  1990     3
  5:  1990-04 105.7  1990     4
 ---                           
421:  2024-12 215.6  2024    12
422:  2025-01 216.1  2025     1
423:  2025-02 216.8  2025     2
424:  2025-03 217.2  2025     3
425:  2025-04 218.0  2025     4
> d25[,year:=year(CONVEYANCE_DATE)] # add year to d25
> d25[,month:=month(CONVEYANCE_DATE)] # add month to d25
> d25 <- merge(d25,dc,by=c("year","month"),all.x=TRUE) # merge with CPI data
> print(d25)
Key: <year, month>
          year month JURISDICTION_CODE      rollStart     ROLL_NUMBER
         <int> <int>             <int>         <char>          <char>
      1:  1902     4               328    13074200000    130742000000
      2:  1905     1               200 02480126145000 024801261450000
      3:  1905     9               200 01359820556000 013598205560000
      4:  1906     6               332        0351500        03515000
      5:  1908     7               303       46250976       462509761
     ---                                                             
1239032:  2025     3               772        1630915        16309150
1239033:  2025     3               789        0757000        07570000
1239034:  2025     3               789        0799500        07995000
1239035:  2025     3               789        0813100        08131000
1239036:  2025     3               789        1066400        10664000
           FOLIO_ID            ACTUAL_USE_DESCRIPTION REGIONAL_DISTRICT
             <char>                            <char>            <char>
      1: A0000299BX Property Subject To Section 19(8)   Metro Vancouver
      2: A000003CUS            Single Family Dwelling   Metro Vancouver
      3: A000001MK8            Single Family Dwelling   Metro Vancouver
      4: A0000HQMGF            Single Family Dwelling           Capital
      5: D0000W5DYZ            Single Family Dwelling     Fraser Valley
     ---                                                               
1239032: A0000KSNQ0            Single Family Dwelling        Strathcona
1239033: A0000BL7VS            Single Family Dwelling  Columbia Shuswap
1239034: A0000BL88C            Single Family Dwelling  Columbia Shuswap
1239035: A0000BL8CB            Single Family Dwelling  Columbia Shuswap
1239036: A0000BLBG1            Single Family Dwelling  Columbia Shuswap
         MB_Year_Built MB_Effective_Year maxBuilt lastDigit minLastDigit
                 <int>             <int>    <int>    <char>       <char>
      1:          1939              1975     1939         0            0
      2:          1958              1965     1958         0            0
      3:          1972              1972     1972         0            0
      4:          1979              1985     1979         0            0
      5:          2015              2015     2015         1            1
     ---                                                                
1239032:          2022              2022     2022         0            0
1239033:          1975              1975     1975         0            0
1239034:          1992              1992     1992         0            0
1239035:          1976              2010     1976         0            0
1239036:          1969              1985     1969         0            0
         CONVEYANCE_DATE CONVEYANCE_PRICE       rollSales nRoll     firstPost
                  <IDat>            <num>          <char> <int>        <IDat>
      1:      1902-04-30          1200000    130742000000     2 2739809-05-02
      2:      1905-01-11           490000 024801261450000     3    2018-11-29
      3:      1905-09-29           256300 013598205560000     4    2014-05-27
      4:      1906-06-15           115000        03515000    48    1982-01-15
      5:      1908-07-15            48000       462509766     7    2016-05-12
     ---                                                                     
1239032:      2025-03-03           140000        16309150     4    2025-03-03
1239033:      2025-03-07           570000        07570000    22    2003-09-16
1239034:      2025-03-10           720000        07995000    19    1997-06-25
1239035:      2025-03-10           610000        08131000     9    1977-05-15
1239036:      2025-03-12           378000        10664000    11    2000-05-12
         saleYearBuilt nSaleYearBuilt lastSaleYearBuilt    preDate    lastPre
                <lgcl>          <int>             <num>     <Date>     <Date>
      1:         FALSE              0                 0 1902-04-30 1902-04-30
      2:         FALSE              0                 0 1905-01-11 1905-01-11
      3:         FALSE              0                 0 1905-09-29 1905-09-29
      4:         FALSE              0                 0 1906-06-15 1906-06-15
      5:         FALSE              0                 0 1908-07-15 2008-03-14
     ---                                                                     
1239032:         FALSE              0                 0 1600-01-01 2016-09-01
1239033:         FALSE              0                 0 1600-01-01 1974-10-15
1239034:         FALSE              0                 0 1600-01-01 1600-01-01
1239035:         FALSE              0                 0 1600-01-01 1600-01-01
1239036:         FALSE              0                 0 1600-01-01 1600-01-01
          yfpost   lastSale   spec specBuy specSale REF_DATE   CPI
           <int>     <IDat> <lgcl>   <int>    <int>   <char> <num>
      1: 2739809 1902-04-30  FALSE       0        0     <NA>    NA
      2:    2018 2018-11-29  FALSE       0        0     <NA>    NA
      3:    2014 2014-05-27  FALSE       0        0     <NA>    NA
      4:    1982 1982-01-15  FALSE       0        0     <NA>    NA
      5:    2016 2020-03-10   TRUE       0        0     <NA>    NA
     ---                                                          
1239032:    2025 2025-03-03  FALSE       0        0  2025-03 217.2
1239033:    2003 2025-03-07  FALSE       0        0  2025-03 217.2
1239034:    1997 2025-03-10  FALSE       0        0  2025-03 217.2
1239035:    1977 2025-03-10   TRUE       0        0  2025-03 217.2
1239036:    2000 2025-03-12  FALSE       0        0  2025-03 217.2
> d25[,realPrice:= CONVEYANCE_PRICE/CPI] # create real value
> 
> dv <- d25[REGIONAL_DISTRICT=="Metro Vancouver",]
> dv[,isOld:=(CONVEYANCE_DATE<firstPost) | year(CONVEYANCE_DATE)<MB_Year_Built] # indicates pre-reno sale
> ri <- feols(log(realPrice) ~ i(yearmon(CONVEYANCE_DATE)) + isOld|FOLIO_ID, data=dv) # repeated sale with new home indicator
NOTE: 139,846 observations removed because of NA and infinite values (LHS: 139,846).
The variable 'yearmon(CONVEYANCE_DATE)::2025.16666666667' has been removed because of collinearity (see $collin.var).
> # extract monthly coefficients only
> ri_coef <- coef(ri)[grepl("yearmon", names(coef(ri)))]
> # make data table with yearmon as date and coefficient
> # typical entry yearmon(CONVEYANCE_DATE)::2024.91666666667 
> ri_dt <- data.table(numericDate=as.numeric(gsub("yearmon\\(CONVEYANCE_DATE\\)::","",names(ri_coef))), repeatedSaleIndex=ri_coef,origName=names(ri_coef))
> print(ri_dt)
     numericDate repeatedSaleIndex                                   origName
           <num>             <num>                                     <char>
  1:    1989.917       -1.36138170 yearmon(CONVEYANCE_DATE)::1989.91666666667
  2:    1990.000       -1.31214667             yearmon(CONVEYANCE_DATE)::1990
  3:    1990.083       -1.29895115 yearmon(CONVEYANCE_DATE)::1990.08333333333
  4:    1990.167       -1.29862182 yearmon(CONVEYANCE_DATE)::1990.16666666667
  5:    1990.250       -1.27238338          yearmon(CONVEYANCE_DATE)::1990.25
 ---                                                                         
419:    2024.750        0.03239854          yearmon(CONVEYANCE_DATE)::2024.75
420:    2024.833        0.06015745 yearmon(CONVEYANCE_DATE)::2024.83333333333
421:    2024.917        0.02264978 yearmon(CONVEYANCE_DATE)::2024.91666666667
422:    2025.000        0.02773438             yearmon(CONVEYANCE_DATE)::2025
423:    2025.083       -0.02424074 yearmon(CONVEYANCE_DATE)::2025.08333333333
> 
> dv[,numericDate:=year(CONVEYANCE_DATE) + (month(CONVEYANCE_DATE)-1)/12] # convert to numeric date
> dsb <- dv[,.(nSpecBuys=sum(spec*(CONVEYANCE_DATE==lastPre))/100,n=.N/100),by=numericDate] # scale to oneish
> rib <- merge(ri_dt, dsb, by="numericDate") # merge with sales data
> rib[,specShare:=100*nSpecBuys/n] # share of spec buys (always quite small)
> rib[,n:=NULL] # drop n now redundant
> rib <- melt(rib, id.vars="numericDate", measure.vars=c("repeatedSaleIndex","nSpecBuys","specShare"), variable.name="measure", value.name="value")
> # plot the coefficients and number of spec buys
> ggplot(rib[numericDate>2000], aes(x=numericDate, y=value, color=measure)) +
+   geom_line() +
+   labs(title="Monthly Repeated Sale Index and Number and share of Spec Buys",
+        x="Numeric Date",
+        y="Value") +
+   scale_color_manual(values=c("blue", "red","green")) +
+   theme_bw()
> # save the plot
> ggsave("text/specTiming.png", width=10, height=6)
> 
> # now sales
> dss <- dv[,.(nSpecSales=sum(spec*(CONVEYANCE_DATE==firstPost))/100),by=numericDate] # scale to oneish
> ris <- merge(ri_dt, dss, by="numericDate") # merge with sales data
> ris <- melt(ris, id.vars="numericDate", measure.vars=c("repeatedSaleIndex","nSpecSales"), variable.name="measure", value.name="value")
> # plot the coefficients and number of spec sales
> ggplot(ris[numericDate>2000], aes(x=numericDate, y=value, color=measure)) +
+   geom_line() +
+   labs(title="Monthly Repeated Sale Index and Number of Spec Sales",
+        x="Numeric Date",
+        y="Value") +
+   scale_color_manual(values=c("blue", "red")) +
+   theme_bw()
> # save the plot
> ggsave("text/specSalesTiming.png", width=10, height=6)
> 
> # print share of all MB_Year_Built that are spec by year
> x <- dv[ (MB_Year_Built>2000) & (lastSale==CONVEYANCE_DATE),.(specShare=sum(spec*yfpost==MB_Year_Built)/.N,count=.N),by=MB_Year_Built]
> print(x[order(MB_Year_Built)])
    MB_Year_Built  specShare count
            <int>      <num> <int>
 1:          2001 0.31456311  2575
 2:          2002 0.28611266  3586
 3:          2003 0.35299783  4153
 4:          2004 0.28239581  4391
 5:          2005 0.27724001  4029
 6:          2006 0.27684964  4190
 7:          2007 0.24964418  3513
 8:          2008 0.16064587  3654
 9:          2009 0.23260285  2601
10:          2010 0.25967130  3955
11:          2011 0.20995247  3577
12:          2012 0.19877489  3265
13:          2013 0.19421635  2801
14:          2014 0.21533333  3000
15:          2015 0.26381910  3184
16:          2016 0.11213518  1953
17:          2017 0.07853403  2292
18:          2018 0.04446797  1889
19:          2019 0.03164140  1517
20:          2020 0.06563040  1158
21:          2021 0.09826990  1445
22:          2022 0.04587629  1940
23:          2023 0.04803150  1270
24:          2024 0.09208820   771
    MB_Year_Built  specShare count
> print(dv[MB_Year_Built>2017,.N,by=c("spec","ACTUAL_USE_DESCRIPTION")])
      spec                           ACTUAL_USE_DESCRIPTION     N
    <lgcl>                                           <char> <int>
 1:  FALSE                           Single Family Dwelling  6348
 2:  FALSE                  Residential Dwelling with Suite 14085
 3:  FALSE  Duplex, Non-Strata Side by Side or Front / Back   544
 4:   TRUE                      Duplex, Strata Front / Back   956
 5:  FALSE                      Duplex, Strata Front / Back   525
 6:  FALSE                      Duplex, Strata Side by Side   280
 7:   TRUE                  Residential Dwelling with Suite  2302
 8:   TRUE                           Single Family Dwelling   809
 9:   TRUE              Row Housing (Single Unit Ownership)   390
10:   TRUE                      Duplex, Strata Side by Side   441
11:  FALSE                         Duplex, Strata Up / Down     6
12:  FALSE                                          Triplex    46
13:   TRUE  Duplex, Non-Strata Side by Side or Front / Back    45
14:   TRUE                                          Triplex     9
15:  FALSE              Row Housing (Single Unit Ownership)   150
16:  FALSE             Vacant Residential Less Than 2 Acres    90
17:  FALSE               Strata-Lot Residence (Condominium)    35
18:  FALSE                     Duplex, Non-Strata Up / Down     5
19:   TRUE               Strata-Lot Residence (Condominium)    15
20:   TRUE             Vacant Residential Less Than 2 Acres     7
21:   TRUE                         Duplex, Strata Up / Down     4
22:  FALSE 2 Acres Or More (Single Family Dwelling, Duplex)     6
      spec                           ACTUAL_USE_DESCRIPTION     N
> 
> 
> proc.time()
   user  system elapsed 
 18.477   3.099  22.558 

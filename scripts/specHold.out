
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # specHold.R 
> # how long to spec builders hold properties?
> # Also, when do they buy?
> # Tom Davidoff
> # 06/04/25
> # Modified as mergeRoll20052025.R does a lot
> 
> # Steps:
> # 1. do mergeRoll20052025.R to get homes built after 2005 and their 2005 characterstics
> # 2. Do this script and get sales for each property
> # 3. Merge the sales data with the 2005 data and learn about spec vs custom
> 
> library(data.table)
> library(fixest)	
> library(RSQLite)
> library(ggplot2)
> 
> # get dates of construction for single family homes 
> # see if roll number ends in zero and no other by lot start works
> 
> # obtain static year built
> 
> DOCOMPILE <- FALSE
> 
> if (DOCOMPILE==TRUE) {
+ 	dd25 <- fread("~/OneDrive\ -\ UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",select=c("JURISDICTION_CODE","ROLL_NUMBER","FOLIO_ID","ACTUAL_USE_DESCRIPTION","REGIONAL_DISTRICT"),colClasses=c(ROLL_NUMBER="character"))
+ 	print(table(dd25[,REGIONAL_DISTRICT])) # see what actual use descriptions are
+ 	dd25 <- dd25[REGIONAL_DISTRICT=="Metro Vancouver"] # drop empty regional districts
+ 	print("moo")
+ 	print(dd25)
+ 	dj25 <- unique(dd25[,.(JURISDICTION_CODE,ROLL_NUMBER,FOLIO_ID)]) # for sales data uniformity
+ 	names(dj25) <- c("JURISDICTION_CODE","ROLL_NUMBER","FOLIO_ID")
+ 
+ 	ds25 <- fread("~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_sales_20250331_REVD25.csv",select=c("FOLIO_ID","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"),colClasses=c(CONVEYANCE_DATE="character"))
+ 	# convert folioID to jurisdiction/roll_number as pre-redevelopment sales will have often same jurisd/roll_number, different FOLIO_ID. Certainly same rollStart
+ 	ds25[,CONVEYANCE_DATE:=as.Date(CONVEYANCE_DATE,format="%Y%m%d%H%M%S")]
+ 	print(head(dd25))
+ 	print(head(dj25))
+ 	print(head(ds25))
+ 	print("foo")
+ 	ds25 <- merge(ds25,dj25,by="FOLIO_ID") # add jurisdiction code and roll number
+ 	print(head(ds25))
+ 	print("foofoo")
+ 
+ 	# Now get 2016 data
+ 	db16 <- dbConnect(RSQLite::SQLite(), "~/OneDrive - UBC/Documents/data/bca/REVD16_and_inventory_extracts.sqlite3")
+ 	df16 <- dbGetQuery(db16, "SELECT folioID, jurisdictionCode, rollNumber FROM folio") 
+ 		ds16 <- dbGetQuery(db16, "SELECT folioID, conveyanceDate, conveyancePrice, conveyanceTypeDescription FROM sales")
+ 	ds16 <- data.table(merge(df16,ds16,by="folioID"))
+ 	setnames(ds16,"folioID","FOLIO_ID") # rename folioID to FOLIO_ID
+ 	setnames(ds16,c("jurisdictionCode","rollNumber","conveyanceDate","conveyancePrice","conveyanceTypeDescription"),c("JURISDICTION_CODE","ROLL_NUMBER","CONVEYANCE_DATE","CONVEYANCE_PRICE","CONVEYANCE_TYPE_DESCRIPTION"))
+ 	ds16[,CONVEYANCE_DATE:=as.Date(CONVEYANCE_DATE,format="%Y-%m-%d")]
+ 	print(head(ds16))
+ 	print(head(ds25))
+ 
+ 	ds1625 <- unique(rbind(ds25,ds16)) # note this procedure should allow duplexes as of 2025 -- but also note in 16 makes unique not happen
+ 	print(nrow(ds25))
+ 	print(nrow(ds16))
+ 	print(nrow(ds1625))
+ 	fwrite(ds1625,"data/derived/sales20162025.csv") # save sales data
+ }
> ds <- fread("data/derived/sales20162025.csv")
> db <- fread("data/derived/newBuilds.csv")
> print(head(ds))
     FOLIO_ID CONVEYANCE_DATE CONVEYANCE_PRICE
       <char>          <IDat>            <num>
1: A000000009      2019-04-05         17309000
2: A000000009      2014-06-16          9450000
3: A000000009      2014-06-05                1
4: A00000000A      2013-02-08          8800000
5: A00000000A      1991-07-09          1700000
6: A00000000B      2006-12-04          3850000
                CONVEYANCE_TYPE_DESCRIPTION JURISDICTION_CODE     ROLL_NUMBER
                                     <char>             <int>          <char>
1: Reject - Not Suitable for Sales Analysis               200 001019632060000
2:     Improved Single Property Transaction               200 001019632060000
3: Reject - Not Suitable for Sales Analysis               200 001019632060000
4:     Improved Single Property Transaction               200 001019632290000
5:     Improved Single Property Transaction               200 001019632290000
6:     Improved Single Property Transaction               200 001019632450000
> print(head(db))
   Jurisdiction  Roll_Number MB_Year_Built value_stru05   FOLIO_ID
          <int>       <char>         <int>        <int>     <char>
1:          328 100081000000          2015        50500 A0000296QK
2:          328 100082000000          2015       132000 A0000296QL
3:          328 100089000000          2014        16100 A0000296QV
4:          328 100090000000          2014        32800 A0000296QW
5:          328 100112000000          2014         9100 A0000296RK
6:          328 100113000000          2018        14000 A0000296RL
> ds[,rollNumeric:=as.numeric(ROLL_NUMBER)] # convert roll number to numeric
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> db[,rollNumeric:=as.numeric(Roll_Number)] # convert roll number to numeric
Warning message:
In eval(jsub, SDenv, parent.frame()) : NAs introduced by coercion
> 
> df <- merge(ds,db,by.x=c("JURISDICTION_CODE","rollNumeric"),by.y=c("Jurisdiction","rollNumeric"))
> print(head(df))
Key: <JURISDICTION_CODE, rollNumeric>
   JURISDICTION_CODE  rollNumeric FOLIO_ID.x CONVEYANCE_DATE CONVEYANCE_PRICE
               <int>        <num>     <char>          <IDat>            <num>
1:               200 1.019633e+12 A00000000C      2021-09-10         14000000
2:               200 1.019633e+12 A00000000C      2021-09-10         14000000
3:               200 1.019633e+12 A00000000C      1991-09-03          2308000
4:               200 1.019633e+12 A00000000C      1991-09-03          2308000
5:               200 1.019633e+12 A00000000C      1981-07-15           875000
6:               200 1.019633e+12 A00000000C      1981-07-15           875000
                CONVEYANCE_TYPE_DESCRIPTION     ROLL_NUMBER     Roll_Number
                                     <char>          <char>          <char>
1: Reject - Not Suitable for Sales Analysis 001019632650000 001019632650000
2: Reject - Not Suitable for Sales Analysis 001019632650000 001019632650000
3:     Improved Single Property Transaction 001019632650000 001019632650000
4:     Improved Single Property Transaction 001019632650000 001019632650000
5:     Improved Single Property Transaction 001019632650000 001019632650000
6:     Improved Single Property Transaction 001019632650000 001019632650000
   MB_Year_Built value_stru05 FOLIO_ID.y
           <int>        <int>     <char>
1:          2008       142000 A00000000C
2:          2008       142000 A00000000C
3:          2008       142000 A00000000C
4:          2008       142000 A00000000C
5:          2008       142000 A00000000C
6:          2008       142000 A00000000C
> 
> q("no")
> proc.time()
   user  system elapsed 
  9.649   3.635   3.171 

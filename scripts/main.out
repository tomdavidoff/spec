
R version 4.4.1 (2024-06-14) -- "Race for Your Life"
Copyright (C) 2024 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # main.R
> # R to analyze spec/custom choice
> # Tom Davidoff
> 
> library(data.table)
> library(readstata13)
> library(fixest)
> library(ggplot2)
> 
> do16 <- 0
> if (do16==1)  {
+     (source("scripts/get16.R"))
+ }
> d16 <- fread("data/derived/baseline16.csv")
> print(summary(d16))
   folioID           roll_number             MB_year_built  MB_effective_year
 Length:25640       Min.   : 1023636540000   Min.   :1900   Min.   :1909     
 Class :character   1st Qu.: 5731056220000   1st Qu.:1942   1st Qu.:1970     
 Mode  :character   Median :16741216240000   Median :1978   Median :1986     
                    Mean   :14145787111320   Mean   :1971   Mean   :1985     
                    3rd Qu.:20586300230000   3rd Qu.:1997   3rd Qu.:2000     
                    Max.   :25830270550000   Max.   :2020   Max.   :2020     
                                             NA's   :24     NA's   :24       
   landValue       improvementValue   streetNumber  streetDirectionPrefix
 Min.   : 199000   Min.   :      0   Min.   :   3   Mode:logical         
 1st Qu.:1020000   1st Qu.:  53500   1st Qu.:1742   NA's:25640           
 Median :1213000   Median : 155000   Median :2879                        
 Mean   :1470442   Mean   : 238800   Mean   :3046                        
 3rd Qu.:1870000   3rd Qu.: 293000   3rd Qu.:4032                        
 Max.   :8880000   Max.   :3801000   Max.   :8571                        
                                     NA's   :2                           
  streetName         streetType        streetDirectionSuffix  postalCode       
 Length:25640       Length:25640       Length:25640          Length:25640      
 Class :character   Class :character   Class :character      Class :character  
 Mode  :character   Mode  :character   Mode  :character      Mode  :character  
                                                                               
                                                                               
                                                                               
                                                                               
     city             thirty          fifty           laneok       
 Length:25640       Mode :logical   Mode :logical   Mode :logical  
 Class :character   FALSE:4991      FALSE:20649     FALSE:503      
 Mode  :character   TRUE :20649     TRUE :4991      TRUE :23474    
                                                    NA's :1663     
                                                                   
                                                                   
                                                                   
> 
> do24 <- 0
> if (do24==1)  {
+     (source("scripts/get24.R"))
+ }
> d24 <- fread("data/derived/use24.csv")
> print(summary(d24))
   FOLIO_ID         ACTUAL_USE_DESCRIPTION JURISDICTION_CODE NEIGHBOURHOOD     
 Length:77530       Length:77530           Min.   :200       Length:77530      
 Class :character   Class :character       1st Qu.:200       Class :character  
 Mode  :character   Mode  :character       Median :200       Mode  :character  
                                           Mean   :200                         
                                           3rd Qu.:200                         
                                           Max.   :200                         
                                                                               
     nchar      splitspot    rollStart            rollEnd24       
 Min.   :15   Min.   :11   Min.   : 101963206   Min.   :   0.000  
 1st Qu.:15   1st Qu.:11   1st Qu.: 813073905   1st Qu.:   0.000  
 Median :15   Median :11   Median :1721681936   Median :   0.000  
 Mean   :15   Mean   :11   Mean   :1507320016   Mean   :   0.694  
 3rd Qu.:15   3rd Qu.:11   3rd Qu.:2163827160   3rd Qu.:   0.000  
 Max.   :15   Max.   :11   Max.   :2583027085   Max.   :4001.000  
                                                                  
  Jurisdiction MB_Year_Built     Zoning          ROLL_NUMBER24           
 Min.   :200   Min.   :1900   Length:77530       Min.   : 1019632060000  
 1st Qu.:200   1st Qu.:1950   Class :character   1st Qu.: 8130739050000  
 Median :200   Median :1986   Mode  :character   Median :17216819360000  
 Mean   :200   Mean   :1977                      Mean   :15073200163654  
 3rd Qu.:200   3rd Qu.:2008                      3rd Qu.:21638271600000  
 Max.   :200   Max.   :2023                      Max.   :25830270850000  
               NA's   :523                                               
 STREET_NUMBER   STREET_DIRECTION_PREFIX STREET_NAME        STREET_TYPE       
 Min.   :    1   Length:77530            Length:77530       Length:77530      
 1st Qu.: 1753   Class :character        Class :character   Class :character  
 Median : 3074   Mode  :character        Mode  :character   Mode  :character  
 Mean   : 3229                                                                
 3rd Qu.: 4465                                                                
 Max.   :74088                                                                
 NA's   :21                                                                   
 STREET_DIRECTION_SUFFIX POSTAL_CODE        fullStreet24      
 Length:77530            Length:77530       Length:77530      
 Class :character        Class :character   Class :character  
 Mode  :character        Mode  :character   Mode  :character  
                                                              
                                                              
                                                              
                                                              
 streetNoNumber24   streetNumber24 
 Length:77530       Min.   :    1  
 Class :character   1st Qu.: 1753  
 Mode  :character   Median : 3074  
                    Mean   : 3229  
                    3rd Qu.: 4465  
                    Max.   :74088  
                    NA's   :21     
> 
> 
> # merge on roll number fragment
> 
> d24[,rollStart:=as.numeric(rollStart)]
> d24[,rollEnd24:=as.numeric(rollEnd24)]
> 
> d16[,rollStart:=floor(roll_number/10000)]
> d16[,rollEnd16:=roll_number %% 10000]
> 
> d24 <- merge(d24,d16,by.x=c("rollStart"),by.y=c("rollStart")) 
> print(summary(d24))
   rollStart           FOLIO_ID         ACTUAL_USE_DESCRIPTION
 Min.   :1.024e+08   Length:31936       Length:31936          
 1st Qu.:5.737e+08   Class :character   Class :character      
 Median :1.676e+09   Mode  :character   Mode  :character      
 Mean   :1.436e+09                                            
 3rd Qu.:2.059e+09                                            
 Max.   :2.583e+09                                            
                                                              
 JURISDICTION_CODE NEIGHBOURHOOD          nchar      splitspot 
 Min.   :200       Length:31936       Min.   :15   Min.   :11  
 1st Qu.:200       Class :character   1st Qu.:15   1st Qu.:11  
 Median :200       Mode  :character   Median :15   Median :11  
 Mean   :200                          Mean   :15   Mean   :11  
 3rd Qu.:200                          3rd Qu.:15   3rd Qu.:11  
 Max.   :200                          Max.   :15   Max.   :11  
                                                               
   rollEnd24        Jurisdiction MB_Year_Built     Zoning         
 Min.   :0.00000   Min.   :200   Min.   :1900   Length:31936      
 1st Qu.:0.00000   1st Qu.:200   1st Qu.:1949   Class :character  
 Median :0.00000   Median :200   Median :1989   Mode  :character  
 Mean   :0.01976   Mean   :200   Mean   :1979                     
 3rd Qu.:0.00000   3rd Qu.:200   3rd Qu.:2011                     
 Max.   :3.00000   Max.   :200   Max.   :2023                     
                                 NA's   :137                      
 ROLL_NUMBER24            STREET_NUMBER   STREET_DIRECTION_PREFIX
 Min.   : 1023636540000   Min.   :    2   Length:31936           
 1st Qu.: 5737097260000   1st Qu.: 1551   Class :character       
 Median :16758201410000   Median : 2887   Mode  :character       
 Mean   :14362021408364   Mean   : 3041                          
 3rd Qu.:20587300480001   3rd Qu.: 4048                          
 Max.   :25830270550000   Max.   :74088                          
                          NA's   :4                              
 STREET_NAME        STREET_TYPE        STREET_DIRECTION_SUFFIX
 Length:31936       Length:31936       Length:31936           
 Class :character   Class :character   Class :character       
 Mode  :character   Mode  :character   Mode  :character       
                                                              
                                                              
                                                              
                                                              
 POSTAL_CODE        fullStreet24       streetNoNumber24   streetNumber24 
 Length:31936       Length:31936       Length:31936       Min.   :    2  
 Class :character   Class :character   Class :character   1st Qu.: 1551  
 Mode  :character   Mode  :character   Mode  :character   Median : 2887  
                                                          Mean   : 3041  
                                                          3rd Qu.: 4048  
                                                          Max.   :74088  
                                                          NA's   :4      
   folioID           roll_number             MB_year_built  MB_effective_year
 Length:31936       Min.   : 1023636540000   Min.   :1900   Min.   :1909     
 Class :character   1st Qu.: 5737097260000   1st Qu.:1946   1st Qu.:1970     
 Mode  :character   Median :16758201410000   Median :1984   Median :1990     
                    Mean   :14362021408364   Mean   :1975   Mean   :1988     
                    3rd Qu.:20587300480000   3rd Qu.:2009   3rd Qu.:2010     
                    Max.   :25830270550000   Max.   :2020   Max.   :2020     
                                             NA's   :50     NA's   :50       
   landValue       improvementValue   streetNumber  streetDirectionPrefix
 Min.   : 199000   Min.   :      0   Min.   :   3   Mode:logical         
 1st Qu.:1020000   1st Qu.:  52900   1st Qu.:1542   NA's:31936           
 Median :1219000   Median : 169000   Median :2886                        
 Mean   :1458804   Mean   : 265909   Mean   :3035                        
 3rd Qu.:1840000   3rd Qu.: 348000   3rd Qu.:4043                        
 Max.   :8880000   Max.   :3801000   Max.   :8571                        
                                     NA's   :4                           
  streetName         streetType        streetDirectionSuffix  postalCode       
 Length:31936       Length:31936       Length:31936          Length:31936      
 Class :character   Class :character   Class :character      Class :character  
 Mode  :character   Mode  :character   Mode  :character      Mode  :character  
                                                                               
                                                                               
                                                                               
                                                                               
     city             thirty          fifty           laneok          rollEnd16
 Length:31936       Mode :logical   Mode :logical   Mode :logical   Min.   :0  
 Class :character   FALSE:6223      FALSE:25713     FALSE:567       1st Qu.:0  
 Mode  :character   TRUE :25713     TRUE :6223      TRUE :27733     Median :0  
                                                    NA's :3636      Mean   :0  
                                                                    3rd Qu.:0  
                                                                    Max.   :0  
                                                                               
> 
> dLaneway <- openxlsx::read.xlsx("data/raw/20250401_UBC_CustomLanewayReport.xlsx")
> #dLaneway <- read.dta13("data/raw/Laneway list 2015-23.dta")
> print(names(dLaneway))
[1] "Area"      "Jur"       "Roll"      "PID"       "PrimAUC"   "MCC"      
[7] "YearBuilt"
> dLaneway <- data.table(dLaneway)[,.(Roll,Jur)]
> print(table(dLaneway[,Jur]))

 200 
5918 
> dLaneway[,Jur==NULL]
logical(0)
> dLaneway[,Roll:=as.character(as.numeric(Roll))]
> dLaneway[,hasLaneway:=1]
> d24[,Roll:=as.character(roll_number)]
> 
> d24 <- merge(d24,dLaneway,by="Roll",all.x=TRUE,all.y=TRUE)
> print(table(d24[,.(is.na(hasLaneway),is.na(rollEnd24))])) # about 50% of laneways -- not bad as all 30 50
       V2
V1      FALSE  TRUE
  FALSE  7441  3957
  TRUE  24495     0
> d24[,hasLaneway:=ifelse(is.na(hasLaneway),0,hasLaneway)]
> 
> # get max transaction date by roll rumber
> dMaxSale <- fread("data/derived/maxSale.csv")
> d24 <- merge(d24,dMaxSale,by.x="ROLL_NUMBER24",by.y="ROLL_NUMBER",all.x=TRUE)
> d24[,duplex:=grepl("Duplex,",ACTUAL_USE_DESCRIPTION)]
> d24[,basement:=grepl("Residential Dwelling with Suite",ACTUAL_USE_DESCRIPTION)]
> d24[,single:=grepl("Single Family Dwelling",ACTUAL_USE_DESCRIPTION)]
> d24[,type:=ifelse(duplex==1,"duplex",ifelse(hasLaneway==1,"laneway",ifelse(basement==1,"basement",ifelse(single==1,"single","other"))))]
> print(table(d24[,type]))

basement   duplex  laneway    other   single 
   12763      740    11386      143    10861 
> print(summary(d24[,MB_Year_Built]))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
   1900    1949    1989    1979    2011    2023    4094 
> d24[,spec:=0]
> d24[,sale2024:=0]
> FIRST_BUILT <- 2017 # results weirdly stronger with 2016 than prior years -- dearth of laneway early messing with fixed effect?
> for (y in seq(FIRST_BUILT,2023)) {
+     #d24[MB_Year_Built==y & (get(paste0("sale",y))==1 | get(paste0("sale",y+1))==1 | get(paste0("sale",y+2))==1  ),spec:=1]
+     d24[MB_Year_Built==y & (get(paste0("sale",y))==1 | get(paste0("sale",y+1))==1  ),spec:=1]
+     #d24[MB_Year_Built==y & ( get(paste0("sale",y+1))==1  ),spec:=1]
+ }
> for (y in seq(FIRST_BUILT,2023)) {
+     print(y)
+     print(table(d24[MB_Year_Built==y,.(type,spec)]))
+ }
[1] 2017
          spec
type         0   1
  basement  51  12
  duplex     1   0
  laneway  295  52
  single    45   6
[1] 2018
          spec
type         0   1
  basement  88   8
  laneway  339  78
  single    49   3
[1] 2019
          spec
type         0   1
  basement  47   8
  duplex    19   1
  laneway  265  54
  single    32   1
[1] 2020
          spec
type         0   1
  basement  39   8
  duplex    38  79
  laneway  189  25
  single    14   1
[1] 2021
          spec
type         0   1
  basement  30  10
  duplex    79 101
  laneway  123  40
  single    18   5
[1] 2022
          spec
type         0   1
  basement  34  10
  duplex   138 107
  laneway  242  29
  single    31   7
[1] 2023
          spec
type         0   1
  basement  31   0
  duplex    87  11
  laneway  119   4
  other      4   0
  single    26   0
> 
> print(table(d24[MB_Year_Built>2016 & MB_Year_Built<2023,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement  67   9
  duplex   139 131
  laneway  505 119
  single    35   2

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement  70  14
  duplex    85 133
  laneway  544 120
  single    23   3

, , STREET_DIRECTION_SUFFIX = N

          spec
type         0   1
  basement   0   0
  duplex     0   1
  laneway    4   2
  single     0   0

, , STREET_DIRECTION_SUFFIX = SE

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement 152  33
  duplex    51  23
  laneway  397  37
  single   131  18

> print(table(d24[thirty==1 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement  49   9
  duplex    45  57
  laneway  350 101
  single    22   1

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement  63   9
  duplex    33  76
  laneway  400  93
  single    12   0

, , STREET_DIRECTION_SUFFIX = N

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    4   2
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement  91  25
  duplex    15   8
  laneway  197  28
  single    67  11

> print(table(d24[thirty==0 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,STREET_DIRECTION_SUFFIX)]))
, , STREET_DIRECTION_SUFFIX = 

          spec
type         0   1
  basement   5   0
  duplex    22  16
  laneway   76   7
  single     9   1

, , STREET_DIRECTION_SUFFIX = E

          spec
type         0   1
  basement   2   2
  duplex    15  20
  laneway   55  16
  single     1   0

, , STREET_DIRECTION_SUFFIX = SE

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , STREET_DIRECTION_SUFFIX = W

          spec
type         0   1
  basement  45   1
  duplex     7   4
  laneway  126   2
  single    47   3

> print(table(d24[thirty==1 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,NEIGHBOURHOOD)]))
, , NEIGHBOURHOOD = Arbutus Ridge - Mackenzie Heights

          spec
type         0   1
  basement   2   3
  duplex     0   0
  laneway   22   0
  single     4   0

, , NEIGHBOURHOOD = Cambie

          spec
type         0   1
  basement  20   5
  duplex     5   0
  laneway   42   4
  single     6   1

, , NEIGHBOURHOOD = Cedar Cottage

          spec
type         0   1
  basement   6   7
  duplex     0   4
  laneway   15   6
  single     4   0

, , NEIGHBOURHOOD = Collingwood

          spec
type         0   1
  basement   4   0
  duplex     4  12
  laneway   26   3
  single     0   0

, , NEIGHBOURHOOD = Dunbar

          spec
type         0   1
  basement  22   5
  duplex     0   0
  laneway   31   3
  single    24   5

, , NEIGHBOURHOOD = Fraserview

          spec
type         0   1
  basement   1   0
  duplex     0   0
  laneway    3   0
  single     0   0

, , NEIGHBOURHOOD = Grandview

          spec
type         0   1
  basement   0   0
  duplex     2  10
  laneway    5   0
  single     0   0

, , NEIGHBOURHOOD = Hastings East

          spec
type         0   1
  basement  16   0
  duplex    17  12
  laneway   87  30
  single     8   1

, , NEIGHBOURHOOD = Kerrisdale

          spec
type         0   1
  basement   2   3
  duplex     0   2
  laneway   18   0
  single     7   0

, , NEIGHBOURHOOD = Killarney

          spec
type         0   1
  basement   6   2
  duplex     7  17
  laneway   49   9
  single     1   0

, , NEIGHBOURHOOD = Kitsilano

          spec
type         0   1
  basement  16   6
  duplex     4   2
  laneway   29  11
  single     9   2

, , NEIGHBOURHOOD = Knight

          spec
type         0   1
  basement  10   0
  duplex     3   7
  laneway   82  15
  single     1   0

, , NEIGHBOURHOOD = Main & Fraser

          spec
type         0   1
  basement  18   7
  duplex    11  16
  laneway   96  40
  single     5   0

, , NEIGHBOURHOOD = Marpole

          spec
type         0   1
  basement  12   0
  duplex     2   6
  laneway   44   8
  single     3   0

, , NEIGHBOURHOOD = Oakridge

          spec
type         0   1
  basement   2   0
  duplex     0   0
  laneway    3   3
  single     1   0

, , NEIGHBOURHOOD = Point Grey

          spec
type         0   1
  basement  27   3
  duplex     7   1
  laneway   58   6
  single    23   3

, , NEIGHBOURHOOD = Renfrew

          spec
type         0   1
  basement  19   2
  duplex    13  18
  laneway  147  51
  single     4   0

, , NEIGHBOURHOOD = Renfrew Heights

          spec
type         0   1
  basement   6   0
  duplex     4  13
  laneway   45  15
  single     0   0

, , NEIGHBOURHOOD = South Granville

          spec
type         0   1
  basement   0   0
  duplex     0   0
  laneway    0   0
  single     1   0

, , NEIGHBOURHOOD = South Vancouver

          spec
type         0   1
  basement  13   0
  duplex    14  21
  laneway  149  20
  single     0   0

, , NEIGHBOURHOOD = Southlands

          spec
type         0   1
  basement   1   0
  duplex     0   0
  laneway    0   0
  single     0   0

> print(table(d24[thirty==0 & MB_Year_Built>2016 & MB_Year_Built<2022,.(type,spec,NEIGHBOURHOOD)]))
, , NEIGHBOURHOOD = Arbutus Ridge - Mackenzie Heights

          spec
type        0  1
  basement 10  0
  duplex    4  2
  laneway  31  0
  single   15  3

, , NEIGHBOURHOOD = Cambie

          spec
type        0  1
  basement  0  0
  duplex    7  0
  laneway   6  0
  single    1  0

, , NEIGHBOURHOOD = Cedar Cottage

          spec
type        0  1
  basement  0  2
  duplex   12  1
  laneway  13  0
  single    1  0

, , NEIGHBOURHOOD = Collingwood

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway  12  3
  single    0  0

, , NEIGHBOURHOOD = Dunbar

          spec
type        0  1
  basement  8  1
  duplex    0  0
  laneway  45  0
  single   11  1

, , NEIGHBOURHOOD = Fraserview

          spec
type        0  1
  basement  2  0
  duplex    2  2
  laneway  16  0
  single    0  0

, , NEIGHBOURHOOD = Grandview

          spec
type        0  1
  basement  0  0
  duplex    0  8
  laneway   0  0
  single    0  0

, , NEIGHBOURHOOD = Hastings East

          spec
type        0  1
  basement  0  0
  duplex   10  4
  laneway   7  2
  single    0  0

, , NEIGHBOURHOOD = Kerrisdale

          spec
type        0  1
  basement  7  0
  duplex    4  0
  laneway  13  4
  single   14  0

, , NEIGHBOURHOOD = Killarney

          spec
type        0  1
  basement  0  0
  duplex    0  4
  laneway   6 13
  single    0  0

, , NEIGHBOURHOOD = Kitsilano

          spec
type        0  1
  basement 11  0
  duplex    0  0
  laneway  22  0
  single    3  0

, , NEIGHBOURHOOD = Main & Fraser

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway  13  0
  single    0  0

, , NEIGHBOURHOOD = Marpole

          spec
type        0  1
  basement  0  0
  duplex    0  8
  laneway   0  0
  single    1  0

, , NEIGHBOURHOOD = Oakridge

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   3  0
  single    0  0

, , NEIGHBOURHOOD = Point Grey

          spec
type        0  1
  basement  7  0
  duplex    0  0
  laneway  22  0
  single    8  0

, , NEIGHBOURHOOD = Renfrew

          spec
type        0  1
  basement  0  0
  duplex    1 11
  laneway   9  0
  single    0  0

, , NEIGHBOURHOOD = Renfrew Heights

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   3  0
  single    0  0

, , NEIGHBOURHOOD = Shaughnessy

          spec
type        0  1
  basement  2  0
  duplex    0  0
  laneway   2  0
  single    0  0

, , NEIGHBOURHOOD = South Granville

          spec
type        0  1
  basement  5  0
  duplex    0  0
  laneway   9  0
  single    2  0

, , NEIGHBOURHOOD = South Vancouver

          spec
type        0  1
  basement  0  0
  duplex    4  0
  laneway  23  3
  single    0  0

, , NEIGHBOURHOOD = Southlands

          spec
type        0  1
  basement  0  0
  duplex    0  0
  laneway   5  0
  single    1  0

> 
> # Main regression
> # Dummy for spec vs custom on property type dummies and share 
> shares <- data.table(nbhd=character(),year=numeric(),thirty=integer(),type=character(),shareType=numeric(),typeSpec=numeric(),specShare=numeric(),priceLag=numeric())
> dsales <- fread("data/derived/sales.csv")
> dsales <- merge(dsales,d24[,.(ROLL_NUMBER24,MB_Year_Built,type,NEIGHBOURHOOD,thirty)],by.x="ROLL_NUMBER",by.y="ROLL_NUMBER24")
> dsales <- dsales[CONVEYANCE_DATE==MB_Year_Built | (CONVEYANCE_DATE==MB_Year_Built+1) ]
> KEEPLAG <- 2
> for (y in seq(FIRST_BUILT,2023)) {
+ 	for (n in unique(d24$NEIGHBOURHOOD)) {
+ 		#for (s in c(0,1)) {
+ 		for (s in c(1)) {
+ 			dsub <- d24[NEIGHBOURHOOD==n & MB_Year_Built==y & thirty==s  ]
+ 			for (t in c("single","duplex","laneway","basement")) {
+ 				dss <- dsales[NEIGHBOURHOOD==n & CONVEYANCE_DATE<y & CONVEYANCE_DATE>=(y-KEEPLAG) | CONVEYANCE_DATE==(y-3)  & thirty==s & type==t]
+ 				shares <- rbind(shares,data.table(nbhd=n,year=y,thirty=s,type=t,shareType=dsub[,mean(type==t)],typeSpec=dsub[type==t,mean(spec==1)],specShare=dsub[spec==1,mean(type==t)],priceLag=dss[,median((CONVEYANCE_PRICE),na.rm=TRUE)]))
+ 			}
+ 		    }
+         }
+ }
> print(summary(shares))
     nbhd                year          thirty      type          
 Length:644         Min.   :2017   Min.   :1   Length:644        
 Class :character   1st Qu.:2018   1st Qu.:1   Class :character  
 Mode  :character   Median :2020   Median :1   Mode  :character  
                    Mean   :2020   Mean   :1                     
                    3rd Qu.:2022   3rd Qu.:1                     
                    Max.   :2023   Max.   :1                     
                                                                 
   shareType         typeSpec        specShare         priceLag      
 Min.   :0.0000   Min.   :0.0000   Min.   :0.0000   Min.   : 375000  
 1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:0.0000   1st Qu.:1668900  
 Median :0.1177   Median :0.0000   Median :0.0000   Median :2128571  
 Mean   :0.2500   Mean   :0.1921   Mean   :0.2500   Mean   :2224292  
 3rd Qu.:0.4444   3rd Qu.:0.3077   3rd Qu.:0.4712   3rd Qu.:2747619  
 Max.   :1.0000   Max.   :1.0000   Max.   :1.0000   Max.   :5484524  
 NA's   :152      NA's   :346      NA's   :316      NA's   :33       
> 
> 
> dnew <- d24[MB_Year_Built>FIRST_BUILT & MB_Year_Built<2023]
> print(dnew[MB_Year_Built>2016,mean(spec),by=type])
       type        V1
     <char>     <num>
1:   single 0.1055901
2:   duplex 0.5124555
3:  laneway 0.1632948
4: basement 0.1560284
> print(dnew[MB_Year_Built>2016,mean(spec),by=MB_Year_Built])
   MB_Year_Built        V1
           <int>     <num>
1:          2019 0.1498829
2:          2020 0.2875318
3:          2018 0.1575221
4:          2021 0.3842365
5:          2022 0.2558528
> print(dnew[MB_Year_Built>2016,quantile(improvementValue,na.rm=TRUE),by=.(spec)])
     spec     V1
    <num>  <num>
 1:     0   6800
 2:     0  24800
 3:     0  34800
 4:     0  67350
 5:     0 591000
 6:     1   9400
 7:     1  22300
 8:     1  29200
 9:     1  45700
10:     1 377000
> print(dnew[MB_Year_Built>2016,mean(improvementValue,na.rm=TRUE),by=.(spec)])
    spec       V1
   <num>    <num>
1:     0 58699.01
2:     1 44462.26
> print(summary(feols(improvementValue~spec | MB_Year_Built ^ NEIGHBOURHOOD ^ thirty,data=dnew[MB_Year_Built>2016])))
OLS estimation, Dep. Var.: improvementValue
Observations: 2,389
Fixed-effects: MB_Year_Built^NEIGHBOURHOOD^thirty: 160
Standard-errors: Clustered (MB_Year_Built^NEIGHBOURHOOD^thirty) 
     Estimate Std. Error  t value Pr(>|t|)    
spec -10141.6    3911.09 -2.59303 0.010401 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 48,519.2     Adj. R2: 0.314617
                 Within R2: 0.005951
> print(summary(feols(log(improvementValue)~spec | MB_Year_Built ^ NEIGHBOURHOOD ^ thirty,data=dnew[MB_Year_Built>2016])))
OLS estimation, Dep. Var.: log(improvementValue)
Observations: 2,389
Fixed-effects: MB_Year_Built^NEIGHBOURHOOD^thirty: 160
Standard-errors: Clustered (MB_Year_Built^NEIGHBOURHOOD^thirty) 
      Estimate Std. Error  t value  Pr(>|t|)    
spec -0.176972   0.058708 -3.01446 0.0029972 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.622124     Adj. R2: 0.271497
                 Within R2: 0.010966
> print(summary(feols(landValue~spec | MB_Year_Built ^ NEIGHBOURHOOD ^ thirty,data=dnew[MB_Year_Built>2016])))
OLS estimation, Dep. Var.: landValue
Observations: 2,389
Fixed-effects: MB_Year_Built^NEIGHBOURHOOD^thirty: 160
Standard-errors: Clustered (MB_Year_Built^NEIGHBOURHOOD^thirty) 
     Estimate Std. Error  t value Pr(>|t|) 
spec  3890.31    8787.15 0.442727  0.65856 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 129,011.0     Adj. R2: 0.941239
                  Within R2: 1.246e-4
> print(summary(feols(log(landValue)~spec | MB_Year_Built ^ NEIGHBOURHOOD ^ thirty,data=dnew[MB_Year_Built>2016])))
OLS estimation, Dep. Var.: log(landValue)
Observations: 2,389
Fixed-effects: MB_Year_Built^NEIGHBOURHOOD^thirty: 160
Standard-errors: Clustered (MB_Year_Built^NEIGHBOURHOOD^thirty) 
      Estimate Std. Error   t value Pr(>|t|) 
spec -0.000931   0.006617 -0.140729  0.88826 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.078299     Adj. R2: 0.943346
                 Within R2: 1.938e-5
> dnew[,laneShare:=mean(type=="laneway"),by=.(NEIGHBOURHOOD,MB_Year_Built,thirty)]
> dnew[,singleShare:=mean(type=="single"),by=.(NEIGHBOURHOOD,MB_Year_Built,thirty)]
> dnew[,duplexShare:=mean(type=="duplex"),by=.(NEIGHBOURHOOD,MB_Year_Built,thirty)]
> dnew[,ownShare:=ifelse(type=="laneway",laneShare,ifelse(type=="single",singleShare,duplexShare))]
> 
> 
> # note individual reg actually lower t-stat than group level
> print(summary(feols(spec ~ ownShare + log(improvementValue),data=dnew)))
OLS estimation, Dep. Var.: spec
Observations: 2,389
Standard-errors: IID 
                       Estimate Std. Error   t value   Pr(>|t|)    
(Intercept)            1.013805   0.125174  8.099176 8.7321e-16 ***
ownShare               0.002470   0.029059  0.085003 9.3227e-01    
log(improvementValue) -0.073187   0.011548 -6.337418 2.7844e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.423909   Adj. R2: 0.015909
> print(summary(feols(spec ~ ownShare + log(improvementValue)| MB_Year_Built^NEIGHBOURHOOD +type^MB_Year_Built,data=dnew)))
OLS estimation, Dep. Var.: spec
Observations: 2,389
Fixed-effects: MB_Year_Built^NEIGHBOURHOOD: 100,  type^MB_Year_Built: 19
Standard-errors: Clustered (MB_Year_Built^NEIGHBOURHOOD) 
                       Estimate Std. Error   t value Pr(>|t|)    
ownShare              -0.062832   0.075060 -0.837089 0.404559    
log(improvementValue) -0.043052   0.021008 -2.049360 0.043072 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.365464     Adj. R2: 0.230842
                 Within R2: 0.006858
> print("fraction spec among new by rounded 2016 improvement value")
[1] "fraction spec among new by rounded 2016 improvement value"
> STEP <- 10000
> ggplot(dnew[,.(n=.N,spec=mean(spec)),by=.(improvement=round(improvementValue/STEP)*STEP)],aes(x=improvement,y=spec,size=n)) + geom_point()
> ggsave("text/specImprovement.png")
Saving 7 x 7 in image
> # do it with year_built
> ggplot(dnew[MB_year_built<2016,.(n=.N,spec=mean(spec)),by=.(yearBuilt=MB_year_built)],aes(x=yearBuilt,y=spec,size=n)) + geom_point()
> ggsave("text/specYearBuilt.png")
Saving 7 x 7 in image
> # now effective year
> ggplot(dnew[MB_effective_year<2016,.(n=.N,spec=mean(spec)),by=.(effectiveYear=MB_effective_year)],aes(x=effectiveYear,y=spec,size=n)) + geom_point()
> ggsave("text/specEffectiveYear.png")
Saving 7 x 7 in image
> print(dnew[order(MB_year_built),.(.N,mean(spec)),by=.(MB_year_built)])
    MB_year_built     N         V2
            <int> <int>      <num>
 1:          1905     3 0.00000000
 2:          1906     4 0.00000000
 3:          1907     2 0.00000000
 4:          1908     7 0.00000000
 5:          1910    25 0.44000000
 6:          1911    10 0.50000000
 7:          1912    34 0.67647059
 8:          1913    17 0.52941176
 9:          1914    20 0.40000000
10:          1915     6 0.33333333
11:          1916     3 0.00000000
12:          1918     2 0.00000000
13:          1919     2 0.00000000
14:          1920     9 0.22222222
15:          1921     8 0.87500000
16:          1922    17 0.29411765
17:          1923    15 0.00000000
18:          1924     5 1.00000000
19:          1925    14 0.00000000
20:          1926    45 0.33333333
21:          1927    46 0.30434783
22:          1928    40 0.30000000
23:          1929    16 0.37500000
24:          1930    40 0.25000000
25:          1931    28 0.35714286
26:          1932    10 0.50000000
27:          1935     1 0.00000000
28:          1936     8 0.50000000
29:          1937     6 0.00000000
30:          1938    12 0.16666667
31:          1939    25 0.28000000
32:          1940    25 0.28000000
33:          1941    24 0.33333333
34:          1942    30 0.56666667
35:          1943     5 0.20000000
36:          1944    37 0.54054054
37:          1945    32 0.34375000
38:          1946    51 0.23529412
39:          1947    30 0.30000000
40:          1948    44 0.15909091
41:          1949    21 0.42857143
42:          1950    20 0.20000000
43:          1951    16 0.31250000
44:          1952    18 0.11111111
45:          1953    36 0.33333333
46:          1954     8 0.00000000
47:          1955    30 0.43333333
48:          1956    18 0.05555556
49:          1957    13 0.15384615
50:          1958    18 0.16666667
51:          1959    10 0.60000000
52:          1960     7 0.14285714
53:          1961    10 0.20000000
54:          1962    11 0.63636364
55:          1963     8 0.12500000
56:          1964    20 0.15000000
57:          1965     9 0.00000000
58:          1966    12 0.00000000
59:          1967     2 1.00000000
60:          1968     5 0.00000000
61:          1969     1 0.00000000
62:          1971     2 0.00000000
63:          1972     8 0.25000000
64:          1973     5 0.40000000
65:          1974     7 0.00000000
66:          1975     2 0.00000000
67:          1976     6 0.00000000
68:          1977     5 0.00000000
69:          1978     4 0.00000000
70:          1979     4 1.00000000
71:          1980     4 0.00000000
72:          1981     2 0.00000000
73:          1983     3 0.00000000
74:          1984     2 1.00000000
75:          1987     2 0.00000000
76:          1988     5 0.80000000
77:          1989     6 0.00000000
78:          1993     3 0.00000000
79:          1997     1 0.00000000
80:          1999     1 0.00000000
81:          2017     7 0.00000000
82:          2018   572 0.16083916
83:          2019   444 0.14639640
84:          2020   194 0.36597938
85:            NA    49 0.12244898
    MB_year_built     N         V2
> print(dnew[order(MB_effective_year),.(.N,mean(spec)),by=.(MB_effective_year)])
    MB_effective_year     N        V2
                <int> <int>     <num>
 1:              1910     1 0.0000000
 2:              1922     2 1.0000000
 3:              1926     5 0.2000000
 4:              1927     2 1.0000000
 5:              1928     3 1.0000000
 6:              1931     7 0.5714286
 7:              1936     4 1.0000000
 8:              1939    13 0.5384615
 9:              1940    12 0.3333333
10:              1941    11 0.3636364
11:              1942    21 0.7142857
12:              1943     5 0.0000000
13:              1944    18 0.6111111
14:              1945    10 0.2000000
15:              1946    19 0.0000000
16:              1947    19 0.4736842
17:              1948    26 0.1923077
18:              1949    21 0.4285714
19:              1950    25 0.2400000
20:              1951    16 0.5000000
21:              1952     3 0.6666667
22:              1953    26 0.1923077
23:              1954     2 0.0000000
24:              1955    53 0.5471698
25:              1956    11 0.0000000
26:              1957    10 0.2000000
27:              1958     6 0.5000000
28:              1959    12 0.5000000
29:              1960   149 0.2953020
30:              1961     4 0.5000000
31:              1962     7 0.8571429
32:              1963     9 0.1111111
33:              1964    17 0.1176471
34:              1965   182 0.3516484
35:              1966     6 0.5000000
36:              1967     3 0.0000000
37:              1968     7 0.0000000
38:              1969     1 0.0000000
39:              1970   117 0.2307692
40:              1971     7 0.0000000
41:              1972     8 0.2500000
42:              1973     7 0.2857143
43:              1974     6 0.1666667
44:              1975    78 0.2435897
45:              1976     3 0.0000000
46:              1977     8 0.0000000
47:              1978     4 0.0000000
48:              1979     4 1.0000000
49:              1980    49 0.1632653
50:              1982     4 0.5000000
51:              1983     3 0.0000000
52:              1984     6 0.3333333
53:              1985    28 0.1428571
54:              1987     5 0.0000000
55:              1988     4 1.0000000
56:              1989     6 0.0000000
57:              1990    10 0.1000000
58:              1992     1 0.0000000
59:              1993     3 0.0000000
60:              1995     6 0.0000000
61:              1997     1 0.0000000
62:              1999     1 0.0000000
63:              2000     3 0.0000000
64:              2017     6 0.0000000
65:              2018   427 0.1615925
66:              2019   574 0.1498258
67:              2020   213 0.3427230
68:                NA    49 0.1224490
    MB_effective_year     N        V2
> print(dnew[improvementValue>400000])
Key: <ROLL_NUMBER24>
    ROLL_NUMBER24          Roll rollStart   FOLIO_ID
            <i64>        <char>     <num>     <char>
 1: 1674032930000 1674032930000 167403293 A0000002CE
 2: 1674032930000 1674032930000 167403293 A0000002CE
 3: 3692042230000 3692042230000 369204223 A000000GQV
 4: 3692042870000 3692042870000 369204287 D0000KF9H6
 5: 4056701150000 4056701150000 405670115 A000000L2L
 6: 4698084750000 4698084750000 469808475 A000000MMV
 7: 5739093590000 5739093590000 573909359 A000000R9U
 8: 5739093590000 5739093590000 573909359 A000000R9U
 9: 6817085950000 6817085950000 681708595 A000000UNK
10: 6817085950000 6817085950000 681708595 A000000UNK
11: 6817085950000 6817085950000 681708595 A000000UNK
12: 9703182310000 9703182310000 970318231 A0000019LX
             ACTUAL_USE_DESCRIPTION JURISDICTION_CODE
                             <char>             <int>
 1:          Single Family Dwelling               200
 2:          Single Family Dwelling               200
 3:          Single Family Dwelling               200
 4:          Single Family Dwelling               200
 5:          Single Family Dwelling               200
 6:          Single Family Dwelling               200
 7:          Single Family Dwelling               200
 8:          Single Family Dwelling               200
 9: Residential Dwelling with Suite               200
10: Residential Dwelling with Suite               200
11: Residential Dwelling with Suite               200
12:          Single Family Dwelling               200
                        NEIGHBOURHOOD nchar splitspot rollEnd24 Jurisdiction
                               <char> <int>     <int>     <num>        <int>
 1:                        Point Grey    15        11         0          200
 2:                        Point Grey    15        11         0          200
 3:                            Dunbar    15        11         0          200
 4:                            Dunbar    15        11         0          200
 5: Arbutus Ridge - Mackenzie Heights    15        11         0          200
 6: Arbutus Ridge - Mackenzie Heights    15        11         0          200
 7:                        Kerrisdale    15        11         0          200
 8:                        Kerrisdale    15        11         0          200
 9:                        Southlands    15        11         0          200
10:                        Southlands    15        11         0          200
11:                        Southlands    15        11         0          200
12:                            Cambie    15        11         0          200
    MB_Year_Built Zoning STREET_NUMBER STREET_DIRECTION_PREFIX STREET_NAME
            <int> <char>         <int>                  <char>      <char>
 1:          2019    RS1          2675                             WALLACE
 2:          2019    RS1          2655                             WALLACE
 3:          2021    RS1          3483                                18TH
 4:          2018    RS1          3415                                18TH
 5:          2019    RS1          3833                               PUGET
 6:          2018    RS1          2225                                21ST
 7:          2020    RS5          1927                                37TH
 8:          2020    RS5          1927                                37TH
 9:          2020    RS1          1907                                62ND
10:          2020    RS1          7755                            LABURNUM
11:          2020    RS1          1909                                62ND
12:          2022    RS1            63                                22ND
    STREET_TYPE STREET_DIRECTION_SUFFIX POSTAL_CODE      fullStreet24
         <char>                  <char>      <char>            <char>
 1:          ST                                      2675  WALLACE ST
 2:          ST                                      2655  WALLACE ST
 3:         AVE                       W     V6S 1A8  3483  18TH AVE W
 4:         AVE                       W     V6S 1A8  3415  18TH AVE W
 5:          DR                             V6L 2T8    3833  PUGET DR
 6:         AVE                       W     V6L 1J4  2225  21ST AVE W
 7:         AVE                       W     V6M 1N5  1927  37TH AVE W
 8:         AVE                       W     V6M 1N5  1927  37TH AVE W
 9:         AVE                       W     V6P 2G5  1907  62ND AVE W
10:          ST                             V6P 0J3 7755  LABURNUM ST
11:         AVE                       W     V6P 2G5  1909  62ND AVE W
12:         AVE                       W     V5Y 2E9    63  22ND AVE W
    streetNoNumber24 streetNumber24    folioID   roll_number MB_year_built
              <char>          <int>     <char>         <i64>         <int>
 1:       WALLACE ST           2675 A0000002CE 1674032930000          2019
 2:       WALLACE ST           2655 A0000002CE 1674032930000          2019
 3:       18TH AVE W           3483 A000000GQV 3692042230000          1989
 4:       18TH AVE W           3415 D0000KF9H6 3692042870000          2018
 5:         PUGET DR           3833 A000000L2L 4056701150000          2019
 6:       21ST AVE W           2225 A000000MMV 4698084750000          2018
 7:       37TH AVE W           1927 A000000R9U 5739093590000          1925
 8:       37TH AVE W           1927 A000000R9U 5739093590000          1925
 9:       62ND AVE W           1907 A000000UNK 6817085950000          2020
10:      LABURNUM ST           7755 A000000UNK 6817085950000          2020
11:       62ND AVE W           1909 A000000UNK 6817085950000          2020
12:       22ND AVE W             63 A0000019LX 9703182310000          1997
    MB_effective_year landValue improvementValue streetNumber
                <int>     <int>            <int>        <int>
 1:              2019   3574000           591000         3905
 2:              2019   3574000           591000         3905
 3:              2000   2028000           431000         3483
 4:              2018   2920000           454000         3415
 5:              2019   3007000           426000         3833
 6:              2019   2604000           414000         2225
 7:              2000   2671000           486000         1927
 8:              2000   2671000           486000         1927
 9:              2020   2301000           435000         1907
10:              2020   2301000           435000         1907
11:              2020   2301000           435000         1907
12:              1997   2213000           533000           63
    streetDirectionPrefix streetName streetType streetDirectionSuffix
                   <lgcl>     <char>     <char>                <char>
 1:                    NA       11TH        AVE                     W
 2:                    NA       11TH        AVE                     W
 3:                    NA       18TH        AVE                     W
 4:                    NA       18TH        AVE                     W
 5:                    NA      PUGET         DR                      
 6:                    NA       21ST        AVE                     W
 7:                    NA       37TH        AVE                     W
 8:                    NA       37TH        AVE                     W
 9:                    NA       62ND        AVE                     W
10:                    NA       62ND        AVE                     W
11:                    NA       62ND        AVE                     W
12:                    NA       22ND        AVE                     W
    postalCode      city thirty  fifty laneok rollEnd16    Jur hasLaneway
        <char>    <char> <lgcl> <lgcl> <lgcl>     <i64> <char>      <num>
 1:    V6R 2L1 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
 2:    V6R 2L1 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
 3:    V6S 1A8 VANCOUVER   TRUE  FALSE   TRUE         0   <NA>          0
 4:    V6S 1A8 VANCOUVER  FALSE   TRUE   TRUE         0   <NA>          0
 5:    V6L 2T8 VANCOUVER  FALSE   TRUE   TRUE         0   <NA>          0
 6:    V6L 1J4 VANCOUVER  FALSE   TRUE   TRUE         0   <NA>          0
 7:    V6M 1N5 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
 8:    V6M 1N5 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
 9:    V6P 2G5 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
10:    V6P 2G5 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
11:    V6P 2G5 VANCOUVER  FALSE   TRUE   TRUE         0    200          1
12:    V5Y 2E9 VANCOUVER  FALSE   TRUE   TRUE         0   <NA>          0
    sale2010 sale2011 sale2012 sale2013 sale2014 sale2015 sale2016 sale2017
       <int>    <int>    <int>    <int>    <int>    <int>    <int>    <int>
 1:        0        0        0        0        0        0        0        0
 2:        0        0        0        0        0        0        0        0
 3:        0        0        1        0        0        0        0        0
 4:       NA       NA       NA       NA       NA       NA       NA       NA
 5:        1        0        0        0        0        0        0        0
 6:        0        1        0        0        0        0        0        0
 7:        0        0        0        0        0        0        1        0
 8:        0        0        0        0        0        0        1        0
 9:        0        0        0        1        0        0        0        0
10:        0        0        0        1        0        0        0        0
11:        0        0        0        1        0        0        0        0
12:        0        0        0        0        0        0        0        0
    sale2018 sale2019 sale2020 sale2021 sale2022 sale2023 duplex basement
       <int>    <int>    <int>    <int>    <int>    <int> <lgcl>   <lgcl>
 1:        1        0        0        0        0        0  FALSE    FALSE
 2:        1        0        0        0        0        0  FALSE    FALSE
 3:        0        0        1        0        0        0  FALSE    FALSE
 4:       NA       NA       NA       NA       NA       NA  FALSE    FALSE
 5:        1        0        0        0        0        0  FALSE    FALSE
 6:        0        0        0        0        0        1  FALSE    FALSE
 7:        0        0        0        0        0        0  FALSE    FALSE
 8:        0        0        0        0        0        0  FALSE    FALSE
 9:        0        0        0        0        0        0  FALSE     TRUE
10:        0        0        0        0        0        0  FALSE     TRUE
11:        0        0        0        0        0        0  FALSE     TRUE
12:        0        0        1        0        0        0  FALSE    FALSE
    single    type  spec sale2024 laneShare singleShare duplexShare  ownShare
    <lgcl>  <char> <num>    <num>     <num>       <num>       <num>     <num>
 1:   TRUE laneway     0        0 0.6666667   0.3333333           0 0.6666667
 2:   TRUE laneway     0        0 0.6666667   0.3333333           0 0.6666667
 3:   TRUE  single     0        0 0.7142857   0.1904762           0 0.1904762
 4:   TRUE  single     0        0 0.6250000   0.3750000           0 0.3750000
 5:   TRUE  single     0        0 0.4000000   0.3333333           0 0.3333333
 6:   TRUE  single     0        0 0.3333333   0.3333333           0 0.3333333
 7:   TRUE laneway     0        0 0.6666667   0.1666667           0 0.6666667
 8:   TRUE laneway     0        0 0.6666667   0.1666667           0 0.6666667
 9:  FALSE laneway     0        0 1.0000000   0.0000000           0 1.0000000
10:  FALSE laneway     0        0 1.0000000   0.0000000           0 1.0000000
11:  FALSE laneway     0        0 1.0000000   0.0000000           0 1.0000000
12:   TRUE  single     0        0 0.8000000   0.2000000           0 0.2000000
> 
> print(summary(feols(typeSpec~shareType |year ^  type+nbhd,data=shares)))
NOTE: 346 observations removed because of NA values (LHS: 346, RHS: 152, Fixed-effects: 28).
OLS estimation, Dep. Var.: typeSpec
Observations: 298
Fixed-effects: year^type: 26,  nbhd: 21
Standard-errors: Clustered (year^type) 
          Estimate Std. Error t value Pr(>|t|)    
shareType 0.174468     0.0816 2.13808 0.042471 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.233149     Adj. R2: 0.288716
                 Within R2: 0.018498
> print(summary(feols(typeSpec~shareType |nbhd^type+year,data=shares,cluster="nbhd")))
NOTE: 346 observations removed because of NA values (LHS: 346, RHS: 152, Fixed-effects: 28, vcov: 28).
OLS estimation, Dep. Var.: typeSpec
Observations: 298
Fixed-effects: nbhd^type: 72,  year: 7
Standard-errors: Clustered (nbhd) 
          Estimate Std. Error  t value Pr(>|t|) 
shareType 0.048598   0.094808 0.512598  0.61385 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.215498     Adj. R2: 0.303548
                 Within R2: 0.001523
> print(summary(feols(typeSpec~shareType |year^nbhd + type^year,data=shares,cluster="nbhd")))
NOTE: 346 observations removed because of NA values (LHS: 346, RHS: 152, Fixed-effects: 28, vcov: 28).
OLS estimation, Dep. Var.: typeSpec
Observations: 298
Fixed-effects: year^nbhd: 123,  type^year: 26
Standard-errors: Clustered (nbhd) 
          Estimate Std. Error t value Pr(>|t|)    
shareType 0.203857   0.074465 2.73763 0.012687 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.190681     Adj. R2: 0.198551
                 Within R2: 0.025011
> shares[,nbhdType:=paste0(nbhd,"_",type)]
> print(summary(feols(typeSpec~shareType |year^type + nbhd^year ,data=shares,cluster="nbhdType")))
NOTE: 346 observations removed because of NA values (LHS: 346, RHS: 152, Fixed-effects: 28).
OLS estimation, Dep. Var.: typeSpec
Observations: 298
Fixed-effects: year^type: 26,  nbhd^year: 123
Standard-errors: Clustered (nbhdType) 
          Estimate Std. Error t value Pr(>|t|)    
shareType 0.203857   0.102204 1.99461 0.049926 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.190681     Adj. R2: 0.198551
                 Within R2: 0.025011
> print(summary(feols(typeSpec~shareType|year^type + nbhd^year + nbhd^type ,data=shares,cluster="nbhd")))
NOTE: 346 observations removed because of NA values (LHS: 346, RHS: 152, Fixed-effects: 28, vcov: 28).
OLS estimation, Dep. Var.: typeSpec
Observations: 298
Fixed-effects: year^type: 26,  nbhd^year: 123,  nbhd^type: 72
Standard-errors: Clustered (nbhd) 
           Estimate Std. Error   t value Pr(>|t|) 
shareType -0.034485   0.125276 -0.275275  0.78593 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.149267     Adj. R2: 0.061827
                 Within R2: 6.905e-4
> print(summary(feols(specShare~ priceLag |year^type + nbhd^year ,data=shares,cluster="nbhd")))
NOTE: 319 observations removed because of NA values (LHS: 316, RHS: 33, Fixed-effects: 28, vcov: 28).
OLS estimation, Dep. Var.: specShare
Observations: 325
Fixed-effects: year^type: 28,  nbhd^year: 82
Standard-errors: Clustered (nbhd) 
          Estimate Std. Error   t value Pr(>|t|) 
priceLag -7.17e-09   3.98e-08 -0.180248  0.85909 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
RMSE: 0.26777     Adj. R2: 0.236985
                Within R2: 8.073e-5
> # Funny sales result
> print(shares[,mean(priceLag,na.rm=TRUE),by=.(type,year)])
        type  year        V1
      <char> <num>     <num>
 1:   single  2017 2150385.3
 2:   duplex  2017 2084500.2
 3:  laneway  2017  999861.5
 4: basement  2017 1505030.0
 5:   single  2018 2704840.0
 6:   duplex  2018 2460097.1
 7:  laneway  2018 1238139.6
 8: basement  2018 2008933.2
 9:   single  2019 3110060.5
10:   duplex  2019 2652934.9
11:  laneway  2019 1947725.4
12: basement  2019 2981745.2
13:   single  2020 3042994.2
14:   duplex  2020 2644469.1
15:  laneway  2020 1962142.7
16: basement  2020 2757648.1
17:   single  2021 2529711.7
18:   duplex  2021 2211739.9
19:  laneway  2021 2208030.4
20: basement  2021 2797318.3
21:   single  2022 2330169.0
22:   duplex  2022 1943334.1
23:  laneway  2022 2110775.8
24: basement  2022 2385929.2
25:   single  2023 2032471.2
26:   duplex  2023 1469495.8
27:  laneway  2023 2101613.2
28: basement  2023 2085425.1
        type  year        V1
> print(shares[,mean(priceLag,na.rm=TRUE),by=.(type,nbhd)])
        type                              nbhd        V1
      <char>                            <char>     <num>
 1:   single                              <NA> 2992290.1
 2:   duplex                              <NA> 1281000.0
 3:  laneway                              <NA> 1772447.1
 4: basement                              <NA> 2682084.9
 5:   single                        Point Grey 3160203.9
 6:   duplex                        Point Grey 2943367.3
 7:  laneway                        Point Grey 1857027.6
 8: basement                        Point Grey 2773013.4
 9:   single                         Kitsilano 2880418.3
10:   duplex                         Kitsilano 2364904.7
11:  laneway                         Kitsilano 1859251.4
12: basement                         Kitsilano 2436646.1
13:   single                            Dunbar 2947605.3
14:   duplex                            Dunbar 2973360.4
15:  laneway                            Dunbar 1852946.1
16: basement                            Dunbar 2535530.5
17:   single Arbutus Ridge - Mackenzie Heights 3047836.1
18:   duplex Arbutus Ridge - Mackenzie Heights 3358475.9
19:  laneway Arbutus Ridge - Mackenzie Heights 1826202.3
20: basement Arbutus Ridge - Mackenzie Heights 2655809.4
21:   single                        Kerrisdale 3096958.7
22:   duplex                        Kerrisdale 2974350.8
23:  laneway                        Kerrisdale 1782209.0
24: basement                        Kerrisdale 2613741.4
25:   single                        Southlands 3104584.0
26:   duplex                        Southlands 2982749.1
27:  laneway                        Southlands 1786368.9
28: basement                        Southlands 2716394.3
29:   single                       Shaughnessy 2999395.6
30:   duplex                       Shaughnessy 2431983.3
31:  laneway                       Shaughnessy 1772447.1
32: basement                       Shaughnessy 2682584.9
33:   single                            Cambie 2819047.6
34:   duplex                            Cambie 2550534.9
35:  laneway                            Cambie 1836224.3
36: basement                            Cambie 2632979.4
37:   single                   South Granville 2992290.1
38:   duplex                   South Granville 1281000.0
39:  laneway                   South Granville 1772447.1
40: basement                   South Granville 2682084.9
41:   single                          Oakridge 2798648.9
42:   duplex                          Oakridge 2320160.0
43:  laneway                          Oakridge 1815732.9
44: basement                          Oakridge 2603895.1
45:   single                           Marpole 2935598.4
46:   duplex                           Marpole 2733176.8
47:  laneway                           Marpole 1866362.9
48: basement                           Marpole 2720472.4
49:   single                         Grandview 2216575.9
50:   duplex                         Grandview  718888.8
51:  laneway                         Grandview 1747433.2
52: basement                         Grandview 2082154.6
53:   single                     Cedar Cottage 2419734.6
54:   duplex                     Cedar Cottage 1884285.7
55:  laneway                     Cedar Cottage 1775868.9
56: basement                     Cedar Cottage 2358695.6
57:   single                     Main & Fraser 2057209.9
58:   duplex                     Main & Fraser 1850850.4
59:  laneway                     Main & Fraser 1765732.9
60: basement                     Main & Fraser 1960705.9
61:   single                   South Vancouver 1327434.9
62:   duplex                   South Vancouver 1104057.1
63:  laneway                   South Vancouver 1701163.1
64: basement                   South Vancouver 1672908.9
65:   single                            Knight 1820935.1
66:   duplex                            Knight 1601894.4
67:  laneway                            Knight 1791972.7
68: basement                            Knight 1854864.6
69:   single                     Hastings East 1893572.3
70:   duplex                     Hastings East 1804469.3
71:  laneway                     Hastings East 1827847.6
72: basement                     Hastings East 1894406.3
73:   single                           Renfrew 2005519.8
74:   duplex                           Renfrew 1953795.7
75:  laneway                           Renfrew 1814005.7
76: basement                           Renfrew 2015972.7
77:   single                   Renfrew Heights 2197695.4
78:   duplex                   Renfrew Heights 1934179.9
79:  laneway                   Renfrew Heights 1762661.4
80: basement                   Renfrew Heights 2089226.4
81:   single                       Collingwood 2199244.2
82:   duplex                       Collingwood 1463809.3
83:  laneway                       Collingwood 1744471.0
84: basement                       Collingwood 2009789.8
85:   single                         Killarney 2105310.9
86:   duplex                         Killarney 1932175.4
87:  laneway                         Killarney 1769105.4
88: basement                         Killarney 1974209.4
89:   single                        Fraserview 2798251.4
90:   duplex                        Fraserview 1534291.6
91:  laneway                        Fraserview 1795876.6
92: basement                        Fraserview 2638496.4
        type                              nbhd        V1
> # is it desirable to have neighbourhood-type dummies?
> 
> shares[,rr:=runif(nrow(shares))]
> x <- feols(shareType ~ rr|type+year+nbhd,data=shares)
NOTE: 152 observations removed because of NA values (LHS: 152, Fixed-effects: 28).
> print(c(var(x$residuals),var(shares$shareType,na.rm=TRUE)))
[1] 0.06062238 0.09126183
> x <- feols(shareType ~ rr|type^year + nbhd^year,data=shares)
NOTE: 152 observations removed because of NA values (LHS: 152, Fixed-effects: 28).
> print(c(var(x$residuals),var(shares$shareType,na.rm=TRUE)))
[1] 0.04711391 0.09126183
> x <- feols(shareType ~ rr|type^year+type^nbhd+nbhd^year,data=shares)
NOTE: 152 observations removed because of NA values (LHS: 152, Fixed-effects: 28).
> print(c(var(x$residuals),var(shares$shareType,na.rm=TRUE)))
[1] 0.03151831 0.09126183
> x <- feols(shareType ~ rr|nbhd^type,data=shares)
NOTE: 152 observations removed because of NA values (LHS: 152, Fixed-effects: 28).
> print(c(var(x$residuals),var(shares$shareType,na.rm=TRUE)))
[1] 0.04411187 0.09126183
> 
> 
> ggplot(shares[type=="laneway",.(type,shareType,typeSpec,year),],aes(x=shareType,y=typeSpec,color=year)) +
+     geom_point() 
Warning message:
Removed 53 rows containing missing values or values outside the scale range
(`geom_point()`). 
> ggsave("text/shareCustom.png")
Saving 7 x 7 in image
Warning message:
Removed 53 rows containing missing values or values outside the scale range
(`geom_point()`). 
> 
> ggplot(shares[,.(shareType,typeSpec,nbhd)],aes(x=shareType,y=typeSpec,color=nbhd)) + geom_point() 
Warning message:
Removed 346 rows containing missing values or values outside the scale range
(`geom_point()`). 
> ggsave("text/shareSpecType.png")
Saving 7 x 7 in image
Warning message:
Removed 346 rows containing missing values or values outside the scale range
(`geom_point()`). 
> 
> 
> 
> proc.time()
   user  system elapsed 
  3.314   0.190   4.921 

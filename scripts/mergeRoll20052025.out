
R version 4.5.0 (2025-04-11) -- "How About a Twenty-Six"
Copyright (C) 2025 The R Foundation for Statistical Computing
Platform: aarch64-apple-darwin20

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # mergeRoll20052016.R
> # merge 2005 and 2016 rolls for Greater Vancouver
> # Identify properties that were built in 2005 or later
> # Note Tsur's conversion code from stata "Landcor Roll+Transactions 2005.do"
> # Tom Davidoff
> # 07/11/25
> 
> library(data.table)
> 
> d2005 <- fread("data/derived/Landcor Roll 2005.csv",select=c("juris_id","psh_rollnum","act_use","year_built","single","suite","value_stru05","value_land05"))
> d2005[,numericRoll:=as.numeric(gsub("[^0-9]","",psh_rollnum))]
> d2005[,rollStart:=substring(numericRoll,1,nchar(numericRoll)-1)]
> setkey(d2005,rollStart,juris_id)
> jurList <- unique(d2005[,juris_id])
> print(jurList)
 [1] 328 312 216 320 301 221 305 306 748 236 570 631 321 537 319 338 220 313 316
[20] 311 776 746 390 303 225 743 733 732 775 200 524 224 560 326 501 310 745 734
[39] 742 314 527 736 744 432 346 504 739
> #d2005 <- d2005[single==1]
> 
> diri <- "~/OneDrive - UBC/Documents/data/bca/Residential_inventory_202501/"
> dirf <- list.files(diri)
> 
> di25 <- data.table(Jurisdiction=numeric(),Roll_Number=character(),MB_Year_Built=numeric())
> for (f in paste0(diri,dirf)) {
+ 	d <- fread(f,select=c("Jurisdiction","Roll_Number","MB_Year_Built"),colClasses=c(Roll_Number="character",Jurisdiction="numeric") )
+ 	di25 <- rbind(di25,d)
+ }
> di25 <- di25[!is.na(MB_Year_Built)]
> di25[,numericRoll:=as.numeric(gsub("[^0-9]","",Roll_Number))]
> di25[,rollStart:=substring(numericRoll,1,nchar(numericRoll)-1)]
> di25 <- di25[Jurisdiction %in% jurList]
> # confine to single family and duplexes
> # confine to single famil
> 
> dd25 <- fread("~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_descriptions_20250331_REVD25.csv",select=c("FOLIO_ID","ROLL_NUMBER","ACTUAL_USE_DESCRIPTION","JURISDICTION_CODE"))
> useList <- c("Single Family Dwelling","Duplex, Strata Side by Side","Duplex, Strata Front / Back","Duplex, Strata Up / Down","Duplex, Non-Strata Side by Side or Front / Back","Duplex, Non-Strata Up / Down","Residential Dwelling with Suite")
> dd25 <- dd25[ACTUAL_USE_DESCRIPTION %in% useList]
> print(head(dd25))
     FOLIO_ID     ROLL_NUMBER          ACTUAL_USE_DESCRIPTION JURISDICTION_CODE
       <char>          <char>                          <char>             <int>
1: A00000002S 001025638140000          Single Family Dwelling               200
2: A00000002T 001025638280000          Single Family Dwelling               200
3: A00000002U 001025638480000          Single Family Dwelling               200
4: A00000002V 001025638660000          Single Family Dwelling               200
5: A00000002W 001025638920000          Single Family Dwelling               200
6: A00000002X 001025638950000 Residential Dwelling with Suite               200
> dd25[,numericRoll:=as.numeric(gsub("[^0-9]","",ROLL_NUMBER))]
> setnames(dd25,"JURISDICTION_CODE","Jurisdiction")
> di25 <- merge(di25,dd25[,.(numericRoll,Jurisdiction,FOLIO_ID,ACTUAL_USE_DESCRIPTION)],by=c("numericRoll","Jurisdiction"))
> 
> # grab folio addresses file to see where missings are
> d25add <- fread("~/OneDrive - UBC/Documents/data/bca/data_advice_REVD25_20250331/bca_folio_addresses_20250331_REVD25.csv",select=c("FOLIO_ID","STREET_NUMBER","STREET_DIRECTION_PREFIX","STREET_NAME","STREET_TYPE","STREET_DIRECTION_SUFFIX","CITY"))
> d25add[,address:=paste(STREET_NUMBER,STREET_DIRECTION_PREFIX,STREET_NAME,STREET_TYPE,STREET_DIRECTION_SUFFIX,sep=" ")]
> di25 <- merge(di25,d25add[,.(FOLIO_ID,address)],by="FOLIO_ID",all.x=TRUE)
> 
> 
> print(nrow(di25))
[1] 491291
> print(head(di25))
Key: <FOLIO_ID>
     FOLIO_ID  numericRoll Jurisdiction     Roll_Number MB_Year_Built
       <char>        <num>        <int>          <char>         <num>
1: A000000009 1.019632e+12          200 001019632060000          2018
2: A00000000A 1.019632e+12          200 001019632290000          1915
3: A00000000B 1.019632e+12          200 001019632450000          1945
4: A00000000C 1.019633e+12          200 001019632650000          2008
5: A00000000C 1.019633e+12          200 001019632650000          2008
6: A00000000D 1.019633e+12          200 001019632760000          2022
      rollStart          ACTUAL_USE_DESCRIPTION            address
         <char>                          <char>             <char>
1: 101963206000          Single Family Dwelling 4888  BELMONT AVE 
2: 101963229000          Single Family Dwelling  4898  FANNIN AVE 
3: 101963245000 Residential Dwelling with Suite  4874  FANNIN AVE 
4: 101963265000          Single Family Dwelling  4850  FANNIN AVE 
5: 101963265000          Single Family Dwelling  4860  FANNIN AVE 
6: 101963276000          Single Family Dwelling  4811  FANNIN AVE 
> print(head(d2005))
Key: <rollStart, juris_id>
   juris_id        psh_rollnum act_use year_built single suite value_stru05
      <int>             <char>   <int>      <int>  <int> <int>        <int>
1:      328 000000100035000000       0       1972      1     0        55500
2:      328 000000010004000000       0       1993      1     0      1019000
3:      328 000000100051000000      54         NA      0     0      3466000
4:      328 000000100071000000       0       1950      1     0        52900
5:      328 000000100072000000       0       1910      1     0        67300
6:      328 000000100074000000       0       1997      1     0       389000
   value_land05 numericRoll  rollStart
          <int>       <num>     <char>
1:       783000 1.00035e+11 1.00035e+1
2:      1217000 1.00040e+10  1.0004e+1
3:      3972000 1.00051e+11 1.00051e+1
4:       510000 1.00071e+11 1.00071e+1
5:       510000 1.00072e+11 1.00072e+1
6:       551000 1.00074e+11 1.00074e+1
> setnames(d2005,"juris_id","Jurisdiction")
> 
> di25 <- merge(di25,d2005,by=c("rollStart","Jurisdiction"),all.x=TRUE,all.y=TRUE)
> print(nrow(di25))
[1] 1107605
> print(head(di25))
Key: <rollStart, Jurisdiction>
    rollStart Jurisdiction   FOLIO_ID numericRoll.x  Roll_Number MB_Year_Built
       <char>        <int>     <char>         <num>       <char>         <num>
1:  1.0002e+1          328 A000028ZD9    1.0002e+10 010002000000          1936
2: 1.00035e+1          328       <NA>            NA         <NA>            NA
3:  1.0003e+1          328 A000028ZDA    1.0003e+10 010003000000          1951
4:  1.0004e+1          328 A000028ZDB    1.0004e+10 010004000000          1993
5: 1.00051e+1          328       <NA>            NA         <NA>            NA
6:  1.0005e+1          328 A000028ZDD    1.0005e+10 010005000000          1937
   ACTUAL_USE_DESCRIPTION          address        psh_rollnum act_use
                   <char>           <char>             <char>   <int>
1: Single Family Dwelling 7030  MARINE DR                <NA>      NA
2:                   <NA>             <NA> 000000100035000000       0
3: Single Family Dwelling 7040  MARINE DR                <NA>      NA
4: Single Family Dwelling 7050  MARINE DR  000000010004000000       0
5:                   <NA>             <NA> 000000100051000000      54
6: Single Family Dwelling 7039  MARINE DR                <NA>      NA
   year_built single suite value_stru05 value_land05 numericRoll.y
        <int>  <int> <int>        <int>        <int>         <num>
1:         NA     NA    NA           NA           NA            NA
2:       1972      1     0        55500       783000   1.00035e+11
3:         NA     NA    NA           NA           NA            NA
4:       1993      1     0      1019000      1217000   1.00040e+10
5:         NA      0     0      3466000      3972000   1.00051e+11
6:         NA     NA    NA           NA           NA            NA
> print(nrow(di25))
[1] 1107605
> print(table(di25[,.(Jurisdiction,is.na(year_built))]))
            V2
Jurisdiction  FALSE   TRUE
         200 133023  29695
         216   6859    378
         220  18367   2194
         221  14178   2243
         224  55429   1145
         225  24640    926
         236  10554    634
         301  46047   9456
         303  37341   5765
         305 125883   5442
         306  28095   5429
         310   3572    511
         311  24939   8006
         312  19451   6039
         313  30417   5149
         314  18371   3338
         316  20959   4874
         319  21162    576
         320 133807   4665
         321   3216    790
         326  96315  23338
         328  12894   3033
         338  11745   2060
         346     94    233
         390  21024   1749
         432   3268    672
         501   1504    538
         504    222     95
         524   3475    617
         527   1819    281
         537    997    114
         560   2664    367
         570  12330   1876
         631    382    135
         732    886    366
         733   5083    909
         734     89     11
         736      2      3
         739   1060     28
         742     58     27
         743     84     14
         744      3      2
         745    124     26
         746  12861   2952
         748   2237    597
         775   1251    320
         776    471    735
> print(table(di25[,.(Jurisdiction,is.na(MB_Year_Built))]))
            V2
Jurisdiction  FALSE   TRUE
         200  99045  63673
         216   3222   4015
         220  11763   8798
         221   8907   7514
         224  51162   5412
         225  21848   3718
         236   7551   3637
         301  32296  23207
         303  36755   6351
         305 120093  11232
         306  29174   4350
         310   3694    389
         311  22491  10454
         312  19002   6488
         313  23288  12278
         314  19394   2315
         316  20098   5735
         319  20193   1545
         320 112441  26031
         321   3753    253
         326  85035  34618
         328  12882   3045
         338  12164   1641
         346    255     72
         390  16976   5797
         432   3426    514
         501   1942    100
         504    289     28
         524   3621    471
         527   1777    323
         537   1076     35
         560   2494    537
         570  13462    744
         631    437     80
         732    972    280
         733   5205    787
         734      0    100
         736      1      4
         739     26   1062
         742     20     65
         743     26     72
         744      4      1
         745    141      9
         746  13706   2107
         748   2197    637
         775   1007    564
         776    761    445
> print(table(di25[Jurisdiction==200,is.na(year_built)]))

 FALSE   TRUE 
133023  29695 
> print(table(di25[Jurisdiction==200,is.na(MB_Year_Built)]))

FALSE  TRUE 
99045 63673 
> print(table(di25[Jurisdiction==200,single,is.na(MB_Year_Built)]))
       single
is.na       0     1
  FALSE  7491 67701
  TRUE  61126  2547
> # drop non-singles from 2005 roll
> print(summary(di25))
  rollStart          Jurisdiction     FOLIO_ID         numericRoll.x      
 Length:1107605     Min.   :200.0   Length:1107605     Min.   :1.000e+03  
 Class :character   1st Qu.:225.0   Class :character   1st Qu.:3.538e+07  
 Mode  :character   Median :306.0   Mode  :character   Median :2.860e+08  
                    Mean   :305.9                      Mean   :1.813e+12  
                    3rd Qu.:320.0                      3rd Qu.:6.324e+09  
                    Max.   :776.0                      Max.   :2.961e+13  
                                                       NA's   :261533     
 Roll_Number        MB_Year_Built    ACTUAL_USE_DESCRIPTION   address         
 Length:1107605     Min.   :1877     Length:1107605         Length:1107605    
 Class :character   1st Qu.:1976     Class :character       Class :character  
 Mode  :character   Median :1988     Mode  :character       Mode  :character  
                    Mean   :1985                                              
                    3rd Qu.:1998                                              
                    Max.   :2024                                              
                    NA's   :261533                                            
 psh_rollnum           act_use         year_built         single      
 Length:1107605     Min.   : 0.00    Min.   :1879     Min.   :0.000   
 Class :character   1st Qu.: 0.00    1st Qu.:1975     1st Qu.:0.000   
 Mode  :character   Median : 0.00    Median :1986     Median :1.000   
                    Mean   :11.92    Mean   :1982     Mean   :0.713   
                    3rd Qu.:30.00    3rd Qu.:1993     3rd Qu.:1.000   
                    Max.   :70.00    Max.   :2004     Max.   :1.000   
                    NA's   :113698   NA's   :138353   NA's   :113698  
     suite         value_stru05       value_land05      numericRoll.y      
 Min.   :0.000    Min.   :       0   Min.   :       0   Min.   :1.000e+03  
 1st Qu.:0.000    1st Qu.:   73700   1st Qu.:  144000   1st Qu.:3.579e+07  
 Median :0.000    Median :  114000   Median :  238000   Median :3.253e+08  
 Mean   :0.078    Mean   :  138372   Mean   :  260709   Mean   :2.341e+12  
 3rd Qu.:0.000    3rd Qu.:  173000   3rd Qu.:  315000   3rd Qu.:7.193e+09  
 Max.   :1.000    Max.   :42754000   Max.   :35793000   Max.   :3.062e+13  
 NA's   :113698   NA's   :115311     NA's   :115311     NA's   :113698     
> di25 <- di25[single==1 & !is.na(single) & !is.na(MB_Year_Built)]
> print(summary(di25[,year_built==MB_Year_Built]))
   Mode   FALSE    TRUE    NA's 
logical  198484  495235    1223 
> di25[,structureLand:=value_stru05/value_land05]
> summary(di25[MB_Year_Built==year_built,structureLand])
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.3175  0.5172     Inf  0.7701     Inf 
> summary(di25[MB_Year_Built!=year_built,structureLand])
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
0.0007622 0.2816382 0.5271376       Inf 0.8733766       Inf 
> # are there mess ups of *older*
> print(summary(di25[MB_Year_Built!=year_built,MB_Year_Built]))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1877    1983    1992    1994    2005    2024 
> print(summary(di25[MB_Year_Built!=year_built,year_built]))
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1879    1973    1985    1980    1993    2004 
> print(di25[MB_Year_Built!=year_built & MB_Year_Built<year_built,.(psh_rollnum,Roll_Number)])
              psh_rollnum  Roll_Number
                   <char>       <char>
    1: 000000100090000000 010009000000
    2: 000000100120000000 010012000000
    3: 000000100370000000 010037000000
    4: 000000130521000000 130521000000
    5: 000000000000001002     00001001
   ---                                
73625: 000000000000998307      0998303
73626: 000000000000998308      0998303
73627: 000000000099951390    099951391
73628: 000000000099951430    099951436
73629: 000000000099951478    099951470
> print(summary(di25[MB_Year_Built!=year_built & (as.numeric(psh_rollnum)==as.numeric(Roll_Number)),.(MB_Year_Built,year_built)]))
 MB_Year_Built    year_built  
 Min.   :1877   Min.   :1889  
 1st Qu.:2011   1st Qu.:1941  
 Median :2015   Median :1952  
 Mean   :2014   Mean   :1951  
 3rd Qu.:2019   3rd Qu.:1962  
 Max.   :2024   Max.   :2004  
Warning messages:
1: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
2: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
> print(table(di25[MB_Year_Built<2005 & MB_Year_Built!=year_built,ACTUAL_USE_DESCRIPTION]))

Duplex, Non-Strata Side by Side or Front / Back 
                                            653 
                   Duplex, Non-Strata Up / Down 
                                             13 
                    Duplex, Strata Front / Back 
                                              8 
                    Duplex, Strata Side by Side 
                                            356 
                Residential Dwelling with Suite 
                                          26420 
                         Single Family Dwelling 
                                         120860 
> print(table(di25[MB_Year_Built<2005 & MB_Year_Built!=year_built & (as.numeric(psh_rollnum)==as.numeric(Roll_Number)),MB_Year_Built-year_built]))

-86 -77 -70 -66 -61 -60 -58 -57 -54 -53 -49 -46 -45 -42 -41 -39 -36 -33 -31 -30 
  1   2   1   2   1   1   1   1   1   1   2   4   1   3   2   1   2   2   2   2 
-29 -28 -26 -25 -24 -23 -21 -20 -19 -18 -17 -16 -15 -14 -13 -12 -11 -10  -9  -8 
  1   1   1   2   5   6   3   2   2   4   3   1   2   1   1   4   7   4   8   5 
 -7  -6  -5  -4  -3  -2  -1   1   2   3   4   5   6   7   8   9  10  11  12  13 
  2   5   8   6   9  16  32  85  22  13   9   8  13   9   7   4   6   8   4   4 
 14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33 
  3   1   2   5   4   1  10   3   4   1   6   4   5   5   3   2   6   7   4   1 
 34  35  36  37  38  39  40  41  42  43  44  45  46  47  48  49  50  51  52  53 
  6   2   7   1   3   4   1   4   1   3   6   5   9   4   2   4   8   3   2  11 
 54  55  56  57  58  59  60  61  62  63  64  66  67  68  69  70  71  72  74  75 
  4   5   4   1   6   2   6   4   6   3   6   3   3   5   3   2   1   1   2   1 
 76  77  78  79  80  81  83  84  90  92  93  94  99 
  5   4   2   2   2   1   1   1   1   1   1   1   1 
Warning messages:
1: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
2: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
> di25[,duplex:=grepl("Duplex",ACTUAL_USE_DESCRIPTION)]
> di25 <- di25[as.numeric(psh_rollnum)==as.numeric(Roll_Number) | duplex]
Warning messages:
1: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
2: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
> print("Post-purge")
[1] "Post-purge"
> print(summary(di25[MB_Year_Built!=year_built & (as.numeric(psh_rollnum)==as.numeric(Roll_Number)),.(MB_Year_Built,year_built)]))
 MB_Year_Built    year_built  
 Min.   :1877   Min.   :1889  
 1st Qu.:2011   1st Qu.:1941  
 Median :2015   Median :1952  
 Mean   :2014   Mean   :1951  
 3rd Qu.:2019   3rd Qu.:1962  
 Max.   :2024   Max.   :2004  
Warning messages:
1: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
2: In eval(.massagei(isub), x, ienv) : NAs introduced by coercion
> print(summary(di25))
  rollStart          Jurisdiction     FOLIO_ID         numericRoll.x      
 Length:300798      Min.   :200.0   Length:300798      Min.   :1.000e+03  
 Class :character   1st Qu.:220.0   Class :character   1st Qu.:4.473e+08  
 Mode  :character   Median :311.0   Mode  :character   Median :6.214e+09  
                    Mean   :294.8                      Mean   :3.467e+12  
                    3rd Qu.:326.0                      3rd Qu.:5.766e+11  
                    Max.   :776.0                      Max.   :2.961e+13  
                                                                          
 Roll_Number        MB_Year_Built  ACTUAL_USE_DESCRIPTION   address         
 Length:300798      Min.   :1877   Length:300798          Length:300798     
 Class :character   1st Qu.:1968   Class :character       Class :character  
 Mode  :character   Median :1984   Mode  :character       Mode  :character  
                    Mean   :1980                                            
                    3rd Qu.:1995                                            
                    Max.   :2024                                            
                                                                            
 psh_rollnum           act_use         year_built       single 
 Length:300798      Min.   : 0.000   Min.   :1889   Min.   :1  
 Class :character   1st Qu.: 0.000   1st Qu.:1959   1st Qu.:1  
 Mode  :character   Median : 0.000   Median :1979   Median :1  
                    Mean   : 5.282   Mean   :1973   Mean   :1  
                    3rd Qu.: 0.000   3rd Qu.:1991   3rd Qu.:1  
                    Max.   :40.000   Max.   :2004   Max.   :1  
                                     NA's   :564               
     suite         value_stru05      value_land05      numericRoll.y      
 Min.   :0.0000   Min.   :      0   Min.   :       0   Min.   :1.000e+03  
 1st Qu.:0.0000   1st Qu.:  66300   1st Qu.:  194000   1st Qu.:4.473e+08  
 Median :0.0000   Median : 110000   Median :  276000   Median :6.214e+09  
 Mean   :0.1647   Mean   : 135769   Mean   :  314576   Mean   :3.467e+12  
 3rd Qu.:0.0000   3rd Qu.: 173000   3rd Qu.:  371000   3rd Qu.:5.766e+11  
 Max.   :1.0000   Max.   :7840000   Max.   :10464000   Max.   :2.961e+13  
                  NA's   :25        NA's   :25                            
 structureLand      duplex       
 Min.   :0.0000   Mode :logical  
 1st Qu.:0.2126   FALSE:295803   
 Median :0.4480   TRUE :4995     
 Mean   :   Inf                  
 3rd Qu.:0.7448                  
 Max.   :   Inf                  
 NA's   :25                      
> print(summary(di25[duplex==1 ,.(MB_Year_Built)]))
 MB_Year_Built 
 Min.   :1905  
 1st Qu.:1977  
 Median :2008  
 Mean   :1999  
 3rd Qu.:2021  
 Max.   :2024  
> print(summary(di25[MB_Year_Built==year_built,.(structureLand,year_built)]))
 structureLand      year_built  
 Min.   :0.0000   Min.   :1890  
 1st Qu.:0.2641   1st Qu.:1965  
 Median :0.4984   Median :1981  
 Mean   :   Inf   Mean   :1976  
 3rd Qu.:0.7853   3rd Qu.:1991  
 Max.   :   Inf   Max.   :2004  
> print(summary(di25[MB_Year_Built!=year_built,.(structureLand,year_built)]))
 structureLand         year_built  
 Min.   :0.0007622   Min.   :1889  
 1st Qu.:0.0497453   1st Qu.:1941  
 Median :0.1002577   Median :1952  
 Mean   :0.1774916   Mean   :1951  
 3rd Qu.:0.2140693   3rd Qu.:1963  
 Max.   :5.9056604   Max.   :2004  
> fwrite(di25[MB_Year_Built>2005,.(Jurisdiction,Roll_Number,MB_Year_Built,value_stru05,FOLIO_ID)],"data/derived/newBuilds.csv")
> 
> proc.time()
   user  system elapsed 
 35.383  10.536  13.113 
